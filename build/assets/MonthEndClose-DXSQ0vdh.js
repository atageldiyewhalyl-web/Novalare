import{c as Ts,r as m,p as z,b as $,j as e,d as ce,a as h,A as xs,k as we,a3 as E,l as fs,a9 as Js,a1 as rs,aa as Is,t as o,F as Gs,D as Ds,U as Cs,a5 as ws,Z as Fs,P as Vs,X as Ws,ab as $s}from"./index-DrBwAU1T.js";import{C as D,b as B,c as L,a as F,d as pe}from"./card-Cmu1fk5m.js";import{B as g}from"./badge-BVkw5bJj.js";import{c as qs}from"./api-client-BUzUkZPR.js";import{F as ks,D as Qe,a as es,b as ss,c as Q,d as Ze,g as gs,C as Ms}from"./DevPortal--LMNXygJ.js";import{T as Es}from"./textarea-Dy3VbiTo.js";import{L as Re}from"./label-BCNN39XH.js";import{A as Rs,a as Ps}from"./alert-C2ImY4gp.js";import{C as bs}from"./checkbox-DjjqsiJl.js";import{D as ns,b as is,c as ls,d as cs,e as os,j as ds}from"./dialog-vf0qvQXb.js";import{T as Bs,a as Ls,b as Pe,c as Be}from"./tabs-B1Vb_bsc.js";import{L as js}from"./lock-D9w-vkY7.js";import{M as Ne}from"./message-square-TO7yH2I8.js";import{P as Ns}from"./pen-BV3r-nQd.js";import{T as Ss}from"./trash-2-CxXCVqKn.js";import{B as ps}from"./book-open-BQfJsvX3.js";import{C as _s}from"./index-BSRUjdZ4.js";import{C as As}from"./circle-x-9GgX3eVg.js";import{C as us}from"./circle-Hwsfi-tY.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ks=[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],ys=Ts("eye-off",Ks);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ys=[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]],he=Ts("link",Ys);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xs=[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]],vs=Ts("thumbs-up",Xs);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hs=[["path",{d:"M9 14 4 9l5-5",key:"102s5s"}],["path",{d:"M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5a5.5 5.5 0 0 1-5.5 5.5H11",key:"f3b9sd"}]],as=Ts("undo-2",Hs);function Zs({companyId:T,companyName:Se,period:k,onBack:De}){const[x,W]=m.useState(null),[R,ke]=m.useState(!1),[ue,ne]=m.useState(!1),[Ae,me]=m.useState(!1),[Fe,je]=m.useState(null),[ae,fe]=m.useState(null),[u,_]=m.useState(""),[_e,ie]=m.useState("needs-attention"),[p,se]=m.useState(null),[M,te]=m.useState(null),[U,P]=m.useState(!1),[Ie,Le]=m.useState(null),[j,O]=m.useState([]),[I,G]=m.useState([]),[K,S]=m.useState({}),[Te,qe]=m.useState(new Set),[xe,f]=m.useState([]),[ee,b]=m.useState([]),[oe,v]=m.useState([]),[H,Y]=m.useState([]),[Z,hs]=m.useState(!1),[Oe,Ce]=m.useState(null);m.useEffect(()=>{X(),ye()},[T,k]);const X=async()=>{try{const t=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/month-close/status?companyId=${T}&period=${k}`,{headers:{Authorization:`Bearer ${$}`}});if(t.ok){const s=await t.json();hs(s.isLocked||!1),Ce(s.isLocked?s:null),console.log("Period lock status:",s)}}catch(t){console.error("Failed to load lock status:",t)}},ye=async()=>{ke(!0);try{const t=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/reconciliation?companyId=${T}&period=${k}`,{headers:{Authorization:`Bearer ${$}`}});if(t.ok){const s=await t.json();if(console.log("Reconciliation data loaded:",s),(!s.pre_matched_items||s.pre_matched_items.length===0)&&s.matched_pairs&&s.matched_pairs.length>0){console.log("ðŸ”„ Pre-matched items missing, triggering migration...");try{if((await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/migrate-prematched`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k})})).ok){console.log("âœ… Migration successful, reloading data...");const i=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/reconciliation?companyId=${T}&period=${k}`,{headers:{Authorization:`Bearer ${$}`}});if(i.ok){const n=await i.json();W(n),f(n.unmatched_bank||[]),b(n.unmatched_ledger||[]),v(n.resolved_items||[]),Y(n.follow_up_items||[]);return}}}catch(a){console.error("Migration failed, using original data:",a)}}W(s),f(s.unmatched_bank||[]),b(s.unmatched_ledger||[]),v(s.resolved_items||[]),Y(s.follow_up_items||[])}else{const s=await t.text();console.error("Failed to load reconciliation data:",t.status,s),W(null)}}catch(t){console.error("Failed to load reconciliation data:",t),W(null)}finally{ke(!1)}},w=t=>t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),Ke=t=>{se({...t.transaction}),te("bank"),je(t),ne(!0)},ms=t=>{se({...t.entry}),te("ledger"),fe(t),ne(!0)},Ue=async()=>{if(!p)return;console.log("Saving edited item:",p,M);const t=M==="bank"?Fe?.transaction:ae?.entry;if(!t){o.error("Original item not found");return}M==="bank"&&p?(f(s=>s.map(a=>a.transaction.id===p.id?{...a,transaction:{...a.transaction,...p}}:a)),Y(s=>s.map(a=>a.type==="bank"&&a.item?.transaction?.id===p.id?{...a,item:{...a.item,transaction:{...a.item.transaction,...p}}}:a)),v(s=>s.map(a=>a.type==="bank"&&a.item?.transaction?.id===p.id?{...a,item:{...a.item,transaction:{...a.item.transaction,...p}}}:a))):M==="ledger"&&p&&(b(s=>s.map(a=>a.entry.id===p.id?{...a,entry:{...a.entry,...p}}:a)),Y(s=>s.map(a=>a.type==="ledger"&&a.item?.entry?.id===p.id?{...a,item:{...a.item,entry:{...a.item.entry,...p}}}:a)),v(s=>s.map(a=>a.type==="ledger"&&a.item?.entry?.id===p.id?{...a,item:{...a.item,entry:{...a.item.entry,...p}}}:a))),ne(!1);try{const s={companyId:T,period:k,type:M,originalItem:{id:t.id,date:t.date,description:t.description,amount:t.amount},updatedData:{date:p.date,description:p.description,amount:p.amount}};console.log("ðŸ“¤ Sending update request:",s);const a=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/update-transaction`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(a.ok)console.log("âœ… Transaction updated successfully in backend"),o.success("Transaction updated successfully!");else{const i=await a.text();console.error("Failed to update transaction:",a.status,i),o.error("Failed to save changes. Please try again."),await ye()}}catch(s){console.error("Error updating transaction:",s),o.error("Network error. Please check your connection and try again."),await ye()}},Je=async(t,s)=>{const a=t.transaction.id,i=`approve-${s}-${a}`;S(n=>({...n,[i]:!0})),f(n=>n.filter(r=>r.transaction.id!==a)),v(n=>[...n,{type:"bank",item:t,markedAt:new Date().toISOString(),status:"resolved",resolution:"Transaction sent to Journal Entries section to be recorded"}]);try{const n=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/journal-entries/approve-suggestion`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t})});if(n.ok)console.log("Transaction approved for AI journal entry generation"),o.success("Transaction approved! AI will generate a suggested journal entry in the Draft/Suggested tab.");else{const r=await n.text();console.error("Failed to approve transaction:",n.status,r),o.error("Failed to approve transaction. Please try again."),s==="bank"&&(f(l=>[...l,t]),v(l=>l.filter(c=>!(c.type==="bank"&&c.item?.transaction?.id===a))))}}catch(n){console.error("Failed to approve transaction:",n),o.error("Failed to approve transaction. Please try again."),f(r=>[...r,t]),v(r=>r.filter(l=>!(l.type==="bank"&&l.item?.transaction?.id===a)))}finally{S(n=>({...n,[i]:!1}))}},Ge=async t=>{const s=t.entry.id,a=`reverse-ledger-${s}`;S(i=>({...i,[a]:!0})),b(i=>i.filter(n=>n.entry.id!==s)),v(i=>[...i,{type:"ledger",item:t,markedAt:new Date().toISOString(),status:"resolved",resolution:"Reversing journal entry sent to Journal Entries section"}]);try{const i=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/journal-entries/reverse-je`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,item:t})});if(i.ok)console.log("Reversing journal entry approved"),o.success("Reversing JE created! Check the Draft/Suggested tab to review before posting.");else{const n=await i.text();console.error("Failed to create reversing JE:",i.status,n),o.error("Failed to create reversing JE. Please try again."),b(r=>[...r,t]),v(r=>r.filter(l=>!(l.type==="ledger"&&l.item?.entry?.id===s)))}}catch(i){console.error("Failed to create reversing JE:",i),o.error("Failed to create reversing JE. Please try again."),b(n=>[...n,t]),v(n=>n.filter(r=>!(r.type==="ledger"&&r.item?.entry?.id===s)))}finally{S(i=>({...i,[a]:!1}))}},Ee=async(t,s)=>{const a=s==="bank"?t.transaction.id:t.entry.id,i=`timing-${s}-${a}`;S(n=>({...n,[i]:!0})),s==="bank"?(f(n=>n.filter(r=>r.transaction.id!==a)),v(n=>[...n,{type:"bank",item:t,markedAt:new Date().toISOString(),status:"timing_difference",resolution:"Will clear next period",matchGroupId:`timing-${a}`}])):(b(n=>n.filter(r=>r.entry.id!==a)),v(n=>[...n,{type:"ledger",item:t,markedAt:new Date().toISOString(),status:"timing_difference",resolution:"Will clear next period",matchGroupId:`timing-${a}`}]));try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/mark-timing-difference`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t})})).ok?o.success("Marked as timing difference. Will clear next period."):(o.error("Failed to mark as timing difference."),s==="bank"?(f(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`timing-${a}`))):(b(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`timing-${a}`))))}catch(n){console.error("Failed to mark as timing difference:",n),o.error("Failed to mark as timing difference."),s==="bank"?(f(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`timing-${a}`))):(b(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`timing-${a}`)))}finally{S(n=>({...n,[i]:!1}))}},Ye=async(t,s)=>{const a=s==="bank"?t.transaction.id:t.entry.id,i=`ignore-${s}-${a}`;S(n=>({...n,[i]:!0})),s==="bank"?(f(n=>n.filter(r=>r.transaction.id!==a)),v(n=>[...n,{type:"bank",item:t,markedAt:new Date().toISOString(),status:"ignored",resolution:"Marked as non-issue",matchGroupId:`ignored-${a}`}])):(b(n=>n.filter(r=>r.entry.id!==a)),v(n=>[...n,{type:"ledger",item:t,markedAt:new Date().toISOString(),status:"ignored",resolution:"Marked as non-issue",matchGroupId:`ignored-${a}`}]));try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/mark-ignored`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t})})).ok?o.success("Marked as non-issue. Will not appear again."):(o.error("Failed to mark as ignored."),s==="bank"?(f(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`ignored-${a}`))):(b(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`ignored-${a}`))))}catch(n){console.error("Failed to mark as ignored:",n),o.error("Failed to mark as ignored."),s==="bank"?(f(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`ignored-${a}`))):(b(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`ignored-${a}`)))}finally{S(n=>({...n,[i]:!1}))}},Xe=(t,s)=>{s==="bank"?(je(t),fe(null)):(fe(t),je(null)),te(s),_(""),me(!0)},ts=async()=>{if(!u.trim()){alert("Please enter a note about what information is needed.");return}const t=Fe||ae,s=M,a=s==="bank"?t?.transaction.id:t?.entry.id;s==="bank"&&t?(f(i=>i.filter(n=>n.transaction.id!==a)),Y(i=>[...i,{item:t,type:"bank",note:u,markedAt:new Date().toISOString()}])):s==="ledger"&&t&&(b(i=>i.filter(n=>n.entry.id!==a)),Y(i=>[...i,{item:t,type:"ledger",note:u,markedAt:new Date().toISOString()}]));try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/request-information`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t,note:u})})).ok?(o.success("Flagged for follow-up."),me(!1),_("")):(o.error("Failed to flag for follow-up."),s==="bank"&&t?(f(n=>[...n,t]),Y(n=>n.filter(r=>r.type==="bank"?r.item.transaction.id!==a:!0))):s==="ledger"&&t&&(b(n=>[...n,t]),Y(n=>n.filter(r=>r.type==="ledger"?r.item.entry.id!==a:!0))))}catch(i){console.error("Failed to flag for follow-up:",i),o.error("Failed to flag for follow-up."),s==="bank"&&t?(f(n=>[...n,t]),Y(n=>n.filter(r=>r.type==="bank"?r.item.transaction.id!==a:!0))):s==="ledger"&&t&&(b(n=>[...n,t]),Y(n=>n.filter(r=>r.type==="ledger"?r.item.entry.id!==a:!0)))}},d=t=>{Le(t),O([t]),G([]),P(!0)},N=t=>{O(s=>s.some(i=>i.transaction.id===t.transaction.id)?s.filter(i=>i.transaction.id!==t.transaction.id):[...s,t])},q=t=>{G(s=>s.some(i=>i.entry.id===t.entry.id)?s.filter(i=>i.entry.id!==t.entry.id):[...s,t])},J=t=>t.reduce((s,a)=>{const i="transaction"in a?a.transaction.amount:a.entry.amount;return s+i},0),le=()=>{if(!oe)return[];const t=new Map;return oe.filter(s=>s&&s.item).forEach(s=>{const a=s.matchGroupId||`single-${s.markedAt}`;t.has(a)||t.set(a,[]),t.get(a).push(s)}),Array.from(t.entries()).map(([s,a])=>({groupId:s,items:a}))},Ve=async t=>{const s=j.length>0?j:Ie?[Ie]:[],a=I;if(s.length===0||a.length===0){o.error("Please select at least one item from each side to match.");return}const i=`match-${Date.now()}`,n=s.map(c=>c.transaction.id),r=a.map(c=>c.entry.id);f(c=>c.filter(y=>!n.includes(y.transaction.id))),b(c=>c.filter(y=>!r.includes(y.entry.id)));const l=[];s.forEach(c=>{l.push({type:"bank",item:c,markedAt:new Date().toISOString(),status:"matched",resolution:"Matched items",matchGroupId:i})}),a.forEach(c=>{l.push({type:"ledger",item:c,markedAt:new Date().toISOString(),status:"matched",resolution:"Matched items",matchGroupId:i})}),v(c=>[...c,...l]);try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/match-items`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,bankItems:s,ledgerItems:a})})).ok?(o.success(`Successfully matched ${s.length} bank transaction(s) with ${a.length} ledger entry(ies)!`),P(!1),Le(null),O([]),G([])):(o.error("Failed to match items."),f(y=>[...y,...s]),b(y=>[...y,...a]),v(y=>y.filter(C=>C.matchGroupId!==i)))}catch(c){console.error("Failed to match items:",c),o.error("Failed to match items."),f(y=>[...y,...s]),b(y=>[...y,...a]),v(y=>y.filter(C=>C.matchGroupId!==i))}},ve=async t=>{const s=t.item,a=t.type,i=a==="bank"?s.transaction.id:s.entry.id,n=`reverse-followup-${a}-${i}`;S(r=>({...r,[n]:!0})),Y(r=>r.filter(l=>(l.type==="bank"?l.item.transaction.id:l.item.entry.id)!==i)),a==="bank"?f(r=>[...r,s]):b(r=>[...r,s]);try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/reverse-follow-up`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:a,item:s})})).ok?o.success("Item moved back to Needs Attention."):(o.error("Failed to reverse follow-up item."),Y(l=>[...l,t]),a==="bank"?f(l=>l.filter(c=>c.transaction.id!==i)):b(l=>l.filter(c=>c.entry.id!==i)))}catch(r){console.error("Failed to reverse follow-up item:",r),o.error("Failed to reverse follow-up item."),Y(l=>[...l,t]),a==="bank"?f(l=>l.filter(c=>c.transaction.id!==i)):b(l=>l.filter(c=>c.entry.id!==i))}finally{S(r=>({...r,[n]:!1}))}},ge=async t=>{const s=`unmatch-${t}`;S(r=>({...r,[s]:!0}));const a=x?.pre_matched_items?.find(r=>r.matchGroupId===t);if(!a){o.error("Match group not found."),S(r=>({...r,[s]:!1}));return}W(r=>r&&{...r,pre_matched_items:r.pre_matched_items?.filter(l=>l.matchGroupId!==t)||[]});const i=a.bankTransactions.map(r=>({transaction:r,suggested_action:"Review this unmatched bank transaction"})),n=a.ledgerEntries.map(r=>({entry:r,reason:"Unmatched from pre-matched group",action:"Review this unmatched ledger entry"}));f(r=>[...r,...i]),b(r=>[...r,...n]);try{const r=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/unmatch-group`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,matchGroupId:t})});if(r.ok)o.success(`Unmatched ${a.bankTransactions.length} bank and ${a.ledgerEntries.length} ledger transactions. Moved to Needs Attention.`),ie("needs-attention");else{const l=await r.text();console.error("Failed to unmatch group:",r.status,l),o.error("Failed to unmatch group. Please try again."),W(c=>c&&{...c,pre_matched_items:[...c.pre_matched_items||[],a]}),f(c=>c.filter(y=>!i.some(C=>C.transaction.id===y.transaction.id))),b(c=>c.filter(y=>!n.some(C=>C.entry.id===y.entry.id)))}}catch(r){console.error("Failed to unmatch group:",r),o.error("Failed to unmatch group. Please try again."),W(l=>l&&{...l,pre_matched_items:[...l.pre_matched_items||[],a]}),f(l=>l.filter(c=>!i.some(y=>y.transaction.id===c.transaction.id))),b(l=>l.filter(c=>!n.some(y=>y.entry.id===c.entry.id)))}finally{S(r=>({...r,[s]:!1}))}},He=async(t,s)=>{const a=s==="bank"?t.transaction.id:t.entry.id,i=`delete-${s}-${a}`;S(n=>({...n,[i]:!0})),s==="bank"?f(n=>n.filter(r=>r.transaction.id!==a)):b(n=>n.filter(r=>r.entry.id!==a));try{const n=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/delete-transaction`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t})});if(n.ok)o.success("Transaction deleted successfully.");else{const r=await n.text();console.error("Failed to delete transaction:",n.status,r),o.error("Failed to delete transaction. Please try again."),s==="bank"?f(l=>[...l,t]):b(l=>[...l,t])}}catch(n){console.error("Failed to delete transaction:",n),o.error("Failed to delete transaction. Please try again."),s==="bank"?f(r=>[...r,t]):b(r=>[...r,t])}finally{S(n=>({...n,[i]:!1}))}},be=t=>{const[s,a]=t.split("-");return new Date(parseInt(s),parseInt(a)-1,1).toLocaleDateString("en-US",{month:"long",year:"numeric"})},We=t=>{const s=t.resolution||"",a=t.status||"";return s.includes("Journal Entries section")?{bgColor:"bg-yellow-50",borderColor:"border-yellow-200",badgeBg:"bg-yellow-100",badgeText:"text-yellow-700",badgeBorder:"border-yellow-300",iconColor:"text-yellow-600",buttonBg:"bg-yellow-100 hover:bg-yellow-200 border-yellow-300",buttonText:"text-yellow-700"}:a==="timing_difference"?{bgColor:"bg-blue-50",borderColor:"border-blue-200",badgeBg:"bg-blue-100",badgeText:"text-blue-700",badgeBorder:"border-blue-300",iconColor:"text-blue-600",buttonBg:"bg-blue-100 hover:bg-blue-200 border-blue-300",buttonText:"text-blue-700"}:a==="ignored"?{bgColor:"bg-white",borderColor:"border-gray-300",badgeBg:"bg-gray-50",badgeText:"text-gray-600",badgeBorder:"border-gray-200",iconColor:"text-gray-400",buttonBg:"bg-gray-50 hover:bg-gray-100 border-gray-200",buttonText:"text-gray-600"}:{bgColor:"bg-green-50",borderColor:"border-green-200",badgeBg:"bg-green-100",badgeText:"text-green-700",badgeBorder:"border-green-300",iconColor:"text-green-600",buttonBg:"bg-green-100 hover:bg-green-200 border-green-300",buttonText:"text-green-700"}};if(R)return e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ce,{className:"size-8 text-gray-400 animate-spin mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Loading reconciliation data..."})]})});if(!x)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs(h,{type:"button",variant:"ghost",onClick:De,className:"gap-2",children:[e.jsx(xs,{className:"size-4"}),"Back to Month-End Close"]})}),e.jsxs(Rs,{children:[e.jsx(we,{className:"size-4"}),e.jsxs(Ps,{children:["No reconciliation found for ",Se," - ",be(k),". Please run a bank reconciliation first."]})]})]});const ze=(xe?.length||0)+(ee?.length||0),$e=H?.length||0,Me=oe?.length||0;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(h,{type:"button",variant:"ghost",onClick:De,className:"gap-2",children:[e.jsx(xs,{className:"size-4"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl text-gray-900",children:"Review Bank Reconciliation"}),e.jsxs("p",{className:"text-gray-500 mt-1",children:[Se," - ",be(k)]})]})]})}),Z&&e.jsx("div",{className:"bg-gray-900 text-white p-3 rounded-lg border border-gray-800",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(js,{className:"size-4"}),e.jsxs("p",{className:"text-sm",children:["Period locked Â· Closed ",Oe?.closedAt?new Date(Oe.closedAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):""," Â· Read-only mode"]})]})}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Pre-Matched"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-blue-600",children:x?.pre_matched_items?.length||0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Auto-matched groups"})]})]}),e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Needs Attention"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-red-600",children:ze}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Unmatched items"})]})]}),e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Follow-Up Needed"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-purple-600",children:$e}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Awaiting information"})]})]}),e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Resolved"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-green-600",children:Me}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Completed"})]})]})]}),e.jsxs(Bs,{value:_e,onValueChange:t=>ie(t),className:"space-y-4",children:[e.jsxs(Ls,{children:[e.jsxs(Pe,{value:"needs-attention",className:"gap-2",children:[e.jsx(we,{className:"size-4"}),"Needs Attention",ze>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-red-50 text-red-700 border-red-200",children:ze})]}),e.jsxs(Pe,{value:"follow-up",className:"gap-2",children:[e.jsx(Ne,{className:"size-4"}),"Follow-Up Needed",$e>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-purple-50 text-purple-700 border-purple-200",children:$e})]}),e.jsxs(Pe,{value:"resolved",className:"gap-2",children:[e.jsx(E,{className:"size-4"}),"Resolved / Completed",Me>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-green-50 text-green-700 border-green-200",children:Me})]}),e.jsxs(Pe,{value:"pre-matched",className:"gap-2",children:[e.jsx(he,{className:"size-4"}),"Pre-Matched",(x?.pre_matched_items?.length||0)>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-blue-50 text-blue-700 border-blue-200",children:x?.pre_matched_items?.length||0})]})]}),e.jsxs(Be,{value:"needs-attention",className:"space-y-6",children:[e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(ks,{className:"size-5 text-red-600"}),"Unmatched Bank Transactions"]}),e.jsx(pe,{className:"mt-2",children:"These transactions appear in bank statements but have no matching ledger entries."})]}),e.jsxs(g,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:[xe?.length||0," items"]})]})}),e.jsx(F,{children:xe&&xe.length>0?e.jsx("div",{className:"space-y-3",children:xe.map((t,s)=>e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.transaction.description}),e.jsx(g,{variant:"outline",className:"text-xs",children:t.transaction.date})]}),e.jsxs("p",{className:"text-xs text-gray-600 mb-2",children:[e.jsx("span",{className:"font-medium",children:"Suggested Action:"})," ",t.suggested_action]}),t.suggested_je&&e.jsxs("div",{className:"text-xs bg-white border border-red-200 rounded p-3 mt-2",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-1",children:"AI Suggested Journal Entry:"}),e.jsxs("div",{className:"space-y-1 text-gray-600",children:[e.jsxs("div",{children:["â€¢ Debit: ",t.suggested_je.debit_account]}),e.jsxs("div",{children:["â€¢ Credit: ",t.suggested_je.credit_account]}),e.jsxs("div",{children:["â€¢ Amount: â‚¬",w(t.suggested_je.amount)]})]})]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-lg font-medium mb-2 ${t.transaction.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(t.transaction.amount))]})})]}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t border-red-200",children:[e.jsx(h,{type:"button",size:"sm",className:"gap-2 bg-green-600 hover:bg-green-700",onClick:()=>Je(t,"bank"),disabled:K[`approve-bank-${t.transaction.id}`],children:K[`approve-bank-${t.transaction.id}`]?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-3 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(vs,{className:"size-3"}),"Approve for JE"]})}),e.jsxs(Qe,{children:[e.jsx(es,{asChild:!0,children:e.jsxs(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",children:[e.jsx(he,{className:"size-3"}),"Match"]})}),e.jsx(ss,{align:"start",className:"w-56",children:e.jsxs(Q,{className:"cursor-pointer",onClick:()=>d(t),children:[e.jsx(he,{className:"size-4 mr-2"}),"Match to Ledger Entry"]})})]}),e.jsxs(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",onClick:()=>Ke(t),disabled:Z,children:[e.jsx(Ns,{className:"size-3"}),"Edit / Correct"]}),e.jsxs(Qe,{modal:!1,children:[e.jsx(es,{asChild:!0,children:e.jsx(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",disabled:Z,children:"More Actions"})}),e.jsxs(ss,{align:"end",side:"bottom",sideOffset:8,className:"w-64",children:[e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Ee(t,"bank"),children:[e.jsx(fs,{className:"size-4 mr-2 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Mark as Timing Difference"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Clears next month/period"})]})]}),e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Ye(t,"bank"),children:[e.jsx(ys,{className:"size-4 mr-2 text-gray-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Mark as Non-Issue / Ignore"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Reviewed, no action needed"})]})]}),e.jsx(Ze,{}),e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Xe(t,"bank"),children:[e.jsx(Ne,{className:"size-4 mr-2 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Request Information"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Flag for follow-up"})]})]}),e.jsx(Ze,{}),e.jsxs(Q,{className:"cursor-pointer text-red-600",onClick:()=>He(t,"bank"),children:[e.jsx(Ss,{className:"size-4 mr-2"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Delete Transaction"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Permanently remove"})]})]})]})]})]})]},s))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"size-12 text-green-500 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"All bank transactions have been matched!"})]})})]}),e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(ps,{className:"size-5 text-amber-600"}),"Unmatched Ledger Entries"]}),e.jsx(pe,{className:"mt-2",children:"These entries appear in the general ledger but have no matching bank transactions."})]}),e.jsxs(g,{variant:"outline",className:"bg-amber-50 text-amber-700 border-amber-200",children:[ee?.length||0," items"]})]})}),e.jsx(F,{children:ee&&ee.length>0?e.jsx("div",{className:"space-y-3",children:ee.map((t,s)=>e.jsxs("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.entry.description}),e.jsx(g,{variant:"outline",className:"text-xs",children:t.entry.date})]}),e.jsxs("div",{className:"space-y-1 text-xs text-gray-600",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Reason:"})," ",t.reason]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Recommended Action:"})," ",t.action]}),t.entry.account&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Account:"})," ",t.entry.account]})]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-lg font-medium ${t.entry.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(t.entry.amount))]})})]}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t border-amber-200",children:[e.jsx(h,{type:"button",size:"sm",variant:"outline",className:"gap-2 bg-purple-50 hover:bg-purple-100 text-purple-700 border-purple-200",onClick:()=>Ge(t),disabled:Z||K[`reverse-ledger-${t.entry.id}`],children:K[`reverse-ledger-${t.entry.id}`]?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-3 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"size-3"}),"Reverse JE"]})}),e.jsxs(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",onClick:()=>ms(t),disabled:Z,children:[e.jsx(Ns,{className:"size-3"}),"Edit / Correct"]}),e.jsxs(Qe,{modal:!1,children:[e.jsx(es,{asChild:!0,children:e.jsx(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",disabled:Z,children:"More Actions"})}),e.jsxs(ss,{align:"end",side:"bottom",sideOffset:8,className:"w-64",children:[e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Ee(t,"ledger"),children:[e.jsx(fs,{className:"size-4 mr-2 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Mark as Timing Difference"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Clears next month/period"})]})]}),e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Ye(t,"ledger"),children:[e.jsx(ys,{className:"size-4 mr-2 text-gray-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Mark as Non-Issue / Ignore"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Reviewed, no action needed"})]})]}),e.jsx(Ze,{}),e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Xe(t,"ledger"),children:[e.jsx(Ne,{className:"size-4 mr-2 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Request Information"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Flag for follow-up"})]})]}),e.jsx(Ze,{}),e.jsxs(Q,{className:"cursor-pointer text-red-600",onClick:()=>He(t,"ledger"),children:[e.jsx(Ss,{className:"size-4 mr-2"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Delete Transaction"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Permanently remove"})]})]})]})]})]})]},s))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"size-12 text-green-500 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"All ledger entries have been matched!"})]})})]})]}),e.jsx(Be,{value:"follow-up",children:e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"size-5 text-purple-600"}),"Follow-Up Needed"]}),e.jsx(pe,{className:"mt-2",children:"Items awaiting vendor documents, client responses, or team clarification."})]}),e.jsxs(g,{variant:"outline",className:"bg-purple-50 text-purple-700 border-purple-200",children:[$e," items"]})]})}),e.jsx(F,{children:$e>0?e.jsx("div",{className:"space-y-3",children:H.map((t,s)=>{const a=t.item,i=t.type==="bank",n=i?a.transaction:a.entry;return e.jsxs("div",{className:"p-4 bg-purple-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-purple-100 text-purple-700 border-purple-300",children:i?"Bank":"Ledger"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:n.description}),e.jsx(g,{variant:"outline",className:"text-xs",children:n.date})]}),e.jsxs("div",{className:"text-xs bg-white border border-purple-200 rounded p-3 mt-2",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-1",children:"Follow-up Note:"}),e.jsx("p",{className:"text-gray-600",children:t.note}),e.jsxs("p",{className:"text-gray-400 mt-2",children:["Flagged on: ",new Date(t.markedAt).toLocaleDateString()]})]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-lg font-medium ${n.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(n.amount))]})})]}),e.jsx("div",{className:"flex gap-2 pt-2 border-t border-purple-200",children:e.jsx(h,{type:"button",size:"sm",className:"gap-2 bg-red-600 hover:bg-red-700",onClick:()=>ve(t),disabled:Z||K[`reverse-followup-${t.type}-${n.id}`],children:K[`reverse-followup-${t.type}-${n.id}`]?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-3 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Js,{className:"size-3"}),"Reverse"]})})})]},s)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"size-12 text-green-500 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No items waiting for follow-up!"})]})})]})}),e.jsx(Be,{value:"resolved",children:e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"size-5 text-green-600"}),"Resolved / Completed"]}),e.jsx(pe,{className:"mt-2",children:"All reconciled and cleared items for this period."})]}),e.jsxs(g,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200",children:[Me," items"]})]})}),e.jsx(F,{children:Me>0?e.jsx("div",{className:"space-y-3",children:le().map((t,s)=>{const{groupId:a,items:i}=t;Te.has(a);const n=i.length>1&&i[0].matchGroupId,r=i.filter(C=>C&&C.item&&C.type==="bank"),l=i.filter(C=>C&&C.item&&C.type==="ledger"),c=r.reduce((C,de)=>{if(!de?.item)return C;const A=de.item?.transaction;return A?C+Math.abs(A.amount):C},0),y=l.reduce((C,de)=>{if(!de?.item)return C;const A=de.item?.entry;return A?C+Math.abs(A.amount):C},0);if(n)return e.jsx("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(E,{className:"size-4 text-yellow-600"}),e.jsx(g,{variant:"outline",className:"text-xs bg-yellow-100 text-yellow-700 border-yellow-300",children:"Matched"}),e.jsxs("span",{className:"text-sm font-medium text-gray-900",children:[r.length," Bank â†” ",l.length," Ledger"]}),e.jsx(g,{variant:"outline",className:"text-xs",children:i[0].markedAt?new Date(i[0].markedAt).toLocaleDateString():""})]}),e.jsxs("div",{className:"text-xs bg-white border border-yellow-200 rounded p-3 mt-2",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:"Match Summary:"}),e.jsxs("div",{className:"space-y-1 text-gray-600",children:[e.jsxs("p",{children:["Bank Total: â‚¬",w(c)]}),e.jsxs("p",{children:["Ledger Total: â‚¬",w(y)]})]})]}),r.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Bank Transactions:"}),r.map((C,de)=>{const V=C?.item?.transaction;return V?e.jsx("div",{className:"p-2 bg-white border border-yellow-200 rounded text-xs",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-yellow-50 text-yellow-700",children:"Bank"}),e.jsx("span",{className:"text-gray-900",children:V.description}),e.jsx("span",{className:"text-gray-500",children:V.date})]}),e.jsxs("span",{className:`font-medium ${V.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(V.amount))]})]})},de):null})]}),l.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Ledger Entries:"}),l.map((C,de)=>{const V=C?.item?.entry;return V?e.jsx("div",{className:"p-2 bg-white border border-yellow-200 rounded text-xs",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-yellow-50 text-yellow-700",children:"Ledger"}),e.jsx("span",{className:"text-gray-900",children:V.description}),e.jsx("span",{className:"text-gray-500",children:V.date})]}),e.jsxs("span",{className:`font-medium ${V.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(V.amount))]})]})},de):null})]}),i[0].resolution&&e.jsxs("div",{className:"text-xs bg-white border border-yellow-200 rounded p-3 mt-3",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-1",children:"Resolution:"}),e.jsx("p",{className:"text-gray-600",children:i[0].resolution}),e.jsxs("p",{className:"text-gray-400 mt-2",children:["Resolved on: ",new Date(i[0].markedAt).toLocaleDateString()]})]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:"text-lg font-medium text-yellow-600",children:["â‚¬",w(c)]})})]})},s);{const C=i[0],de=C.item;let A,V;C.type==="vendor"?(A=de?.transaction,V="Vendor"):C.type==="bank"?(A=de?.transaction,V="Bank"):(A=de?.entry,V="Ledger");const re=We(C);return A?e.jsx("div",{className:`p-4 ${re.bgColor} border ${re.borderColor} rounded-lg`,children:e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(E,{className:`size-4 ${re.iconColor}`}),e.jsx(g,{variant:"outline",className:`text-xs ${re.badgeBg} ${re.badgeText} ${re.badgeBorder}`,children:V}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:A.description}),e.jsx(g,{variant:"outline",className:"text-xs",children:A.date})]}),e.jsxs("div",{className:`text-xs bg-white border ${re.borderColor} rounded p-3 mt-2`,children:[e.jsx("div",{className:"font-medium text-gray-900 mb-1",children:"Resolution:"}),e.jsx("p",{className:"text-gray-600",children:C.resolution}),e.jsxs("p",{className:"text-gray-400 mt-2",children:["Resolved on: ",new Date(C.markedAt).toLocaleDateString()]})]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-lg font-medium ${A.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(A.amount))]})})]})},s):(console.warn("Transaction is undefined in resolved item:",C),null)}})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(we,{className:"size-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No resolved items yet."})]})})]})}),e.jsx(Be,{value:"pre-matched",children:e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"size-5 text-blue-600"}),"Pre-Matched Transactions"]}),e.jsx(pe,{className:"mt-2",children:"Transactions that were automatically matched during reconciliation. Review and unmatch if needed."})]}),e.jsxs(g,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:[x?.pre_matched_items?.length||0," groups"]})]})}),e.jsx(F,{children:(x?.pre_matched_items?.length||0)>0?e.jsx("div",{className:"space-y-3",children:x?.pre_matched_items?.map((t,s)=>{const a=t.bankTransactions.reduce((n,r)=>n+Math.abs(r.amount),0),i=t.ledgerEntries.reduce((n,r)=>n+Math.abs(r.amount),0);return e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(he,{className:"size-4 text-blue-600"}),e.jsx(g,{variant:"outline",className:"text-xs bg-blue-100 text-blue-700 border-blue-300",children:"Auto-Matched"}),e.jsxs("span",{className:"text-sm font-medium text-gray-900",children:[t.bankTransactions.length," Bank â†” ",t.ledgerEntries.length," Ledger"]}),e.jsx(g,{variant:"outline",className:"text-xs",children:new Date(t.matchedAt).toLocaleDateString()})]}),e.jsxs("div",{className:"text-xs bg-white border border-blue-200 rounded p-3 mt-2",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:"Match Summary:"}),e.jsxs("div",{className:"space-y-1 text-gray-600",children:[e.jsxs("p",{children:["Bank Total: â‚¬",w(a)]}),e.jsxs("p",{children:["Ledger Total: â‚¬",w(i)]}),e.jsxs("p",{className:"text-gray-400 mt-2",children:["Match ID: ",t.matchGroupId]})]})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Bank Transactions:"}),t.bankTransactions.map((n,r)=>e.jsx("div",{className:"p-2 bg-white border border-blue-200 rounded text-xs",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-blue-50 text-blue-700",children:"Bank"}),e.jsx("span",{className:"text-gray-900",children:n.description}),e.jsx("span",{className:"text-gray-500",children:n.date})]}),e.jsxs("span",{className:`font-medium ${n.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(n.amount))]})]})},r))]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Ledger Entries:"}),t.ledgerEntries.map((n,r)=>e.jsx("div",{className:"p-2 bg-white border border-blue-200 rounded text-xs",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-blue-50 text-blue-700",children:"Ledger"}),e.jsx("span",{className:"text-gray-900",children:n.description}),e.jsx("span",{className:"text-gray-500",children:n.date})]}),e.jsxs("span",{className:`font-medium ${n.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(n.amount))]})]})},r))]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:"text-lg font-medium text-blue-600",children:["â‚¬",w(a)]})})]}),e.jsx("div",{className:"flex gap-2 pt-2 border-t border-blue-200",children:e.jsx(h,{type:"button",size:"sm",variant:"outline",className:"gap-2 bg-red-50 hover:bg-red-100 text-red-700 border-red-200",onClick:()=>ge(t.matchGroupId),disabled:Z||K[`unmatch-${t.matchGroupId}`],children:K[`unmatch-${t.matchGroupId}`]?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-3 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"size-3"}),"Unmatch"]})})})]},s)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(he,{className:"size-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No pre-matched transactions found."})]})})]})})]}),e.jsx(ns,{open:ue,onOpenChange:ne,children:e.jsxs(is,{children:[e.jsxs(ls,{children:[e.jsxs(cs,{children:["Edit ",M==="bank"?"Bank Transaction":"Ledger Entry"]}),e.jsx(os,{children:"Update the transaction details if needed."})]}),p&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Re,{children:"Date"}),e.jsx(rs,{type:"date",value:p.date||"",onChange:t=>se({...p,date:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(Re,{children:"Description"}),e.jsx(rs,{value:p.description||"",onChange:t=>se({...p,description:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(Re,{children:"Amount"}),e.jsx(rs,{type:"number",step:"0.01",value:p.amount||0,onChange:t=>se({...p,amount:parseFloat(t.target.value)})})]})]}),e.jsxs(ds,{children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>ne(!1),children:"Cancel"}),e.jsx(h,{type:"button",onClick:Ue,children:"Save Changes"})]})]})}),e.jsx(ns,{open:Ae,onOpenChange:me,children:e.jsxs(is,{className:"max-w-[600px]",children:[e.jsxs(ls,{children:[e.jsxs(cs,{className:"flex items-center gap-2 text-xl",children:[e.jsx(Ne,{className:"size-5 text-purple-600"}),"Request Information"]}),e.jsx(os,{className:"text-gray-600",children:"Add a note about what information is needed for this transaction."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Re,{className:"text-sm font-medium text-gray-700 mb-2",children:"What information do you need?"}),e.jsx(Es,{value:u,onChange:t=>_(t.target.value),placeholder:"e.g., Need vendor invoice from supplier, Waiting for client approval, Need clarification on purpose...",rows:5,className:"mt-2 resize-none"})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-start gap-2 mb-3",children:[e.jsx(vs,{className:"size-4 text-purple-600 mt-0.5"}),e.jsx("span",{className:"text-sm font-medium text-purple-900",children:"Common follow-ups:"})]}),e.jsxs("ul",{className:"space-y-2 ml-6",children:[e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Vendor invoice required"]}),e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Client inquiry needed"]}),e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Bank statement clarification"]}),e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Team member approval required"]})]})]})]}),e.jsxs(ds,{className:"gap-2",children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>me(!1),children:"Cancel"}),e.jsx(h,{type:"button",onClick:ts,className:"bg-purple-600 hover:bg-purple-700",children:"Flag for Follow-Up"})]})]})}),e.jsx(ns,{open:U,onOpenChange:P,children:e.jsxs(is,{className:"max-w-[90vw] w-[1600px] max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs(ls,{children:[e.jsx(cs,{children:"Match Transactions - Multi-Select"}),e.jsx(os,{children:"Select one or more bank transactions and one or more ledger entries to match them together. Supports many-to-many matching."})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"sticky top-0 bg-white pb-3 border-b border-gray-200 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(ks,{className:"size-4 text-red-600"}),"Bank Transactions"]}),e.jsxs(g,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:[j.length," selected"]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded p-3",children:[e.jsx("div",{className:"text-sm font-medium text-blue-900",children:"Selected Total:"}),e.jsxs("div",{className:`text-2xl font-medium ${J(j)>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(J(j)))]})]})]}),e.jsx("div",{className:"space-y-2",children:xe&&xe.map((t,s)=>{const a=j.some(i=>i.transaction.id===t.transaction.id);return e.jsx("div",{className:`p-3 rounded-lg border-2 transition-all cursor-pointer ${a?"bg-blue-100 border-blue-500 shadow-md":"bg-red-50 border-red-200 hover:border-red-400"}`,onClick:()=>N(t),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(bs,{checked:a,onCheckedChange:()=>N(t),className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.transaction.description}),e.jsxs("div",{className:`text-lg font-medium ${t.transaction.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(t.transaction.amount))]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:t.transaction.date})]})]})},s)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"sticky top-0 bg-white pb-3 border-b border-gray-200 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(ps,{className:"size-4 text-amber-600"}),"Ledger Entries"]}),e.jsxs(g,{variant:"outline",className:"bg-amber-50 text-amber-700 border-amber-200",children:[I.length," selected"]})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded p-3",children:[e.jsx("div",{className:"text-sm font-medium text-purple-900",children:"Selected Total:"}),e.jsxs("div",{className:`text-2xl font-medium ${J(I)>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(J(I)))]})]})]}),e.jsx("div",{className:"space-y-2",children:ee&&ee.map((t,s)=>{const a=I.some(i=>i.entry.id===t.entry.id);return e.jsx("div",{className:`p-3 rounded-lg border-2 transition-all cursor-pointer ${a?"bg-purple-100 border-purple-500 shadow-md":"bg-amber-50 border-amber-200 hover:border-amber-400"}`,onClick:()=>q(t),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(bs,{checked:a,onCheckedChange:()=>q(t),className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.entry.description}),e.jsxs("div",{className:`text-lg font-medium ${t.entry.amount>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",w(Math.abs(t.entry.amount))]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:t.entry.date})]})]})},s)})})]})]})}),(j.length>0||I.length>0)&&e.jsx("div",{className:"border-t border-gray-200 pt-4",children:e.jsx("div",{className:`p-4 rounded-lg border-2 ${Math.abs(J(j)-J(I))<.01?"bg-green-50 border-green-500":"bg-yellow-50 border-yellow-500"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 mb-1",children:Math.abs(J(j)-J(I))<.01?e.jsxs("span",{className:"text-green-700 flex items-center gap-2",children:[e.jsx(E,{className:"size-5"}),"Amounts Match - Ready to Reconcile"]}):e.jsxs("span",{className:"text-yellow-700 flex items-center gap-2",children:[e.jsx(we,{className:"size-5"}),"Amount Difference"]})}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Bank: â‚¬",w(Math.abs(J(j)))," | Ledger: â‚¬",w(Math.abs(J(I)))," | Diff: â‚¬",w(Math.abs(J(j)-J(I)))]})]}),e.jsxs(h,{type:"button",className:"gap-2 bg-green-600 hover:bg-green-700",onClick:()=>Ve(),disabled:Z||j.length===0||I.length===0,children:[e.jsx(he,{className:"size-4"}),"Match ",j.length," Bank â†” ",I.length," Ledger"]})]})})}),e.jsx(ds,{children:e.jsx(h,{type:"button",variant:"outline",onClick:()=>{P(!1),O([]),G([])},children:"Cancel"})})]})}),e.jsx(Is,{})]})}function Qs({companyId:T,companyName:Se,period:k,onBack:De}){const[x,W]=m.useState(null),[R,ke]=m.useState(!1),[ue,ne]=m.useState(!1),[Ae,me]=m.useState(!1),[Fe,je]=m.useState(null),[ae,fe]=m.useState(null),[u,_]=m.useState(""),[_e,ie]=m.useState("needs-attention"),[p,se]=m.useState(null),[M,te]=m.useState(null),[U,P]=m.useState(!1),[Ie,Le]=m.useState(null),[j,O]=m.useState([]),[I,G]=m.useState([]),[K,S]=m.useState({}),[Te,qe]=m.useState(new Set),[xe,f]=m.useState([]),[ee,b]=m.useState([]),[oe,v]=m.useState([]),[H,Y]=m.useState([]),[Z,hs]=m.useState(!1),[Oe,Ce]=m.useState(null);m.useEffect(()=>{X(),ye()},[T,k]);const X=async()=>{try{const t=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/month-close/status?companyId=${T}&period=${k}`,{headers:{Authorization:`Bearer ${$}`}});if(t.ok){const s=await t.json();hs(s.isLocked||!1),Ce(s.isLocked?s:null),console.log("Period lock status:",s)}}catch(t){console.error("Failed to load lock status:",t)}},ye=async()=>{ke(!0);try{const t=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/reconciliation?companyId=${T}&period=${k}`,{headers:{Authorization:`Bearer ${$}`}});if(t.ok){const s=await t.json();console.log("AP Reconciliation data loaded:",s);const a={unmatched_vendor:s.unmatchedVendor||s.unmatched_vendor||[],unmatched_ap:s.unmatchedAP||s.unmatched_ap||[],summary:s.summary||{total_vendor_transactions:(s.matches?.length||0)+(s.unmatchedVendor?.length||0),total_ap_entries:(s.matches?.length||0)+(s.unmatchedAP?.length||0),matched_count:s.matches?.length||0,unmatched_vendor_count:s.unmatchedVendor?.length||0,unmatched_ap_count:s.unmatchedAP?.length||0},resolved_items:s.resolved_items||[],follow_up_items:s.follow_up_items||[],timing_differences:s.timing_differences||[],ignored_items:s.ignored_items||[],pre_matched_items:[],locked:s.locked||!1};s.matches&&s.matches.length>0&&(a.pre_matched_items=s.matches.map((i,n)=>({matchGroupId:`pre-match-${n}`,vendorTransactions:Array.isArray(i.vendor_transaction)?i.vendor_transaction:[i.vendor_transaction],apEntries:i.ap_entries||[],matchedAt:new Date().toISOString(),confidence:i.match_confidence||i.confidence}))),W(a),f(a.unmatched_vendor||[]),b(a.unmatched_ap||[]),v(a.resolved_items||[]),Y(a.follow_up_items||[])}else{const s=await t.text();console.error("Failed to load AP reconciliation data:",t.status,s),W(null)}}catch(t){console.error("Failed to load AP reconciliation data:",t),W(null)}finally{ke(!1)}},w=t=>t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),Ke=t=>{const[s,a]=t.split("-");return new Date(parseInt(s),parseInt(a)-1,1).toLocaleDateString("en-US",{month:"long",year:"numeric"})},ms=t=>{se({...t.transaction}),te("vendor"),je(t),ne(!0)},Ue=t=>{se({...t.entry}),te("ap"),fe(t),ne(!0)},Je=async()=>{if(!p)return;console.log("Saving edited item:",p,M);const t=M==="vendor"?Fe?.transaction:ae?.entry;if(!t){o.error("Original item not found");return}M==="vendor"&&p?(f(s=>s.map(a=>a.transaction.id===p.id?{...a,transaction:{...a.transaction,...p}}:a)),Y(s=>s.map(a=>a.type==="vendor"&&a.item?.transaction?.id===p.id?{...a,item:{...a.item,transaction:{...a.item.transaction,...p}}}:a)),v(s=>s.map(a=>a.type==="vendor"&&a.item?.transaction?.id===p.id?{...a,item:{...a.item,transaction:{...a.item.transaction,...p}}}:a))):M==="ap"&&p&&(b(s=>s.map(a=>a.entry.id===p.id?{...a,entry:{...a.entry,...p}}:a)),Y(s=>s.map(a=>a.type==="ap"&&a.item?.entry?.id===p.id?{...a,item:{...a.item,entry:{...a.item.entry,...p}}}:a)),v(s=>s.map(a=>a.type==="ap"&&a.item?.entry?.id===p.id?{...a,item:{...a.item,entry:{...a.item.entry,...p}}}:a))),ne(!1);try{const s={companyId:T,period:k,type:M,originalItem:{id:t.id,date:t.date,description:t.description,amount:t.amount},updatedData:{date:p.date,description:p.description,amount:p.amount}};console.log("ðŸ“¤ Sending update request:",s);const a=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/update-transaction`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(a.ok)console.log("âœ… Transaction updated successfully in backend"),o.success("Transaction updated successfully!");else{const i=await a.text();console.error("Failed to update transaction:",a.status,i),o.error("Failed to save changes. Please try again."),await ye()}}catch(s){console.error("Error updating transaction:",s),o.error("Network error. Please check your connection and try again."),await ye()}},Ge=async(t,s)=>{const a=t.transaction.id,i=`approve-${s}-${a}`;S(n=>({...n,[i]:!0})),f(n=>n.filter(r=>r.transaction.id!==a)),v(n=>[...n,{type:"vendor",item:t,markedAt:new Date().toISOString(),status:"resolved",resolution:"Transaction sent to Journal Entries section to be recorded"}]);try{const n=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/journal-entries/approve-suggestion`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t})});if(n.ok)console.log("Transaction approved for AI journal entry generation"),o.success("Transaction approved! AI will generate a suggested journal entry in the Draft/Suggested tab.");else{const r=await n.text();console.error("Failed to approve transaction:",n.status,r),o.error("Failed to approve transaction. Please try again."),s==="vendor"&&(f(l=>[...l,t]),v(l=>l.filter(c=>!(c.type==="vendor"&&c.item?.transaction?.id===a))))}}catch(n){console.error("Failed to approve transaction:",n),o.error("Failed to approve transaction. Please try again."),f(r=>[...r,t]),v(r=>r.filter(l=>!(l.type==="vendor"&&l.item?.transaction?.id===a)))}finally{S(n=>({...n,[i]:!1}))}},Ee=async t=>{const s=t.entry.id,a=`reverse-ap-${s}`;S(i=>({...i,[a]:!0})),b(i=>i.filter(n=>n.entry.id!==s)),v(i=>[...i,{type:"ap",item:t,markedAt:new Date().toISOString(),status:"resolved",resolution:"Reversing journal entry sent to Journal Entries section"}]);try{const i=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/journal-entries/reverse-je`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,item:t})});if(i.ok)console.log("Reversing journal entry approved"),o.success("Reversing JE created! Check the Draft/Suggested tab to review before posting.");else{const n=await i.text();console.error("Failed to create reversing JE:",i.status,n),o.error("Failed to create reversing JE. Please try again."),b(r=>[...r,t]),v(r=>r.filter(l=>!(l.type==="ap"&&l.item?.entry?.id===s)))}}catch(i){console.error("Failed to create reversing JE:",i),o.error("Failed to create reversing JE. Please try again."),b(n=>[...n,t]),v(n=>n.filter(r=>!(r.type==="ap"&&r.item?.entry?.id===s)))}finally{S(i=>({...i,[a]:!1}))}},Ye=async(t,s)=>{const a=s==="vendor"?t.transaction.id:t.entry.id,i=`timing-${s}-${a}`;S(n=>({...n,[i]:!0})),s==="vendor"?(f(n=>n.filter(r=>r.transaction.id!==a)),v(n=>[...n,{type:"vendor",item:t,markedAt:new Date().toISOString(),status:"timing_difference",resolution:"Will clear next period",matchGroupId:`timing-${a}`}])):(b(n=>n.filter(r=>r.entry.id!==a)),v(n=>[...n,{type:"ap",item:t,markedAt:new Date().toISOString(),status:"timing_difference",resolution:"Will clear next period",matchGroupId:`timing-${a}`}]));try{const n=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/mark-timing-difference`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t})});if(n.ok)o.success("Marked as timing difference. Will clear next period.");else{const r=await n.text();console.error("Failed to mark as timing difference:",n.status,r),o.error("Failed to mark as timing difference."),s==="vendor"?(f(l=>[...l,t]),v(l=>l.filter(c=>c.matchGroupId!==`timing-${a}`))):(b(l=>[...l,t]),v(l=>l.filter(c=>c.matchGroupId!==`timing-${a}`)))}}catch(n){console.error("Failed to mark as timing difference:",n),o.error("Failed to mark as timing difference."),s==="vendor"?(f(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`timing-${a}`))):(b(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`timing-${a}`)))}finally{S(n=>({...n,[i]:!1}))}},Xe=async(t,s)=>{const a=s==="vendor"?t.transaction.id:t.entry.id,i=`ignore-${s}-${a}`;S(n=>({...n,[i]:!0})),s==="vendor"?(f(n=>n.filter(r=>r.transaction.id!==a)),v(n=>[...n,{type:"vendor",item:t,markedAt:new Date().toISOString(),status:"ignored",resolution:"Marked as non-issue",matchGroupId:`ignored-${a}`}])):(b(n=>n.filter(r=>r.entry.id!==a)),v(n=>[...n,{type:"ap",item:t,markedAt:new Date().toISOString(),status:"ignored",resolution:"Marked as non-issue",matchGroupId:`ignored-${a}`}]));try{const n=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/mark-ignored`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t})});if(n.ok)o.success("Marked as non-issue. Will not appear again.");else{const r=await n.text();console.error("Failed to mark as ignored:",n.status,r),o.error("Failed to mark as ignored."),s==="vendor"?(f(l=>[...l,t]),v(l=>l.filter(c=>c.matchGroupId!==`ignored-${a}`))):(b(l=>[...l,t]),v(l=>l.filter(c=>c.matchGroupId!==`ignored-${a}`)))}}catch(n){console.error("Failed to mark as ignored:",n),o.error("Failed to mark as ignored."),s==="vendor"?(f(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`ignored-${a}`))):(b(r=>[...r,t]),v(r=>r.filter(l=>l.matchGroupId!==`ignored-${a}`)))}finally{S(n=>({...n,[i]:!1}))}},ts=(t,s)=>{s==="vendor"?(je(t),fe(null)):(fe(t),je(null)),te(s),_(""),me(!0)},d=async()=>{if(!u.trim()){alert("Please enter a note about what information is needed.");return}const t=Fe||ae,s=M,a=s==="vendor"?t?.transaction.id:t?.entry.id;s==="vendor"&&t?(f(i=>i.filter(n=>n.transaction.id!==a)),Y(i=>[...i,{item:t,type:"vendor",note:u,markedAt:new Date().toISOString()}])):s==="ap"&&t&&(b(i=>i.filter(n=>n.entry.id!==a)),Y(i=>[...i,{item:t,type:"ap",note:u,markedAt:new Date().toISOString()}]));try{const i=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/request-information`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t,note:u})});if(i.ok)o.success("Flagged for follow-up."),me(!1),_("");else{const n=await i.text();console.error("Failed to flag for follow-up:",i.status,n),o.error("Failed to flag for follow-up."),s==="vendor"&&t?(f(r=>[...r,t]),Y(r=>r.filter(l=>l.type==="vendor"?l.item.transaction.id!==a:!0))):s==="ap"&&t&&(b(r=>[...r,t]),Y(r=>r.filter(l=>l.type==="ap"?l.item.entry.id!==a:!0)))}}catch(i){console.error("Failed to flag for follow-up:",i),o.error("Failed to flag for follow-up."),s==="vendor"&&t?(f(n=>[...n,t]),Y(n=>n.filter(r=>r.type==="vendor"?r.item.transaction.id!==a:!0))):s==="ap"&&t&&(b(n=>[...n,t]),Y(n=>n.filter(r=>r.type==="ap"?r.item.entry.id!==a:!0)))}},N=t=>{Le(t),O([t]),G([]),P(!0)},q=t=>{O(s=>s.some(i=>i.transaction.id===t.transaction.id)?s.filter(i=>i.transaction.id!==t.transaction.id):[...s,t])},J=t=>{G(s=>s.some(i=>i.entry.id===t.entry.id)?s.filter(i=>i.entry.id!==t.entry.id):[...s,t])},le=t=>t.reduce((s,a)=>{const i="transaction"in a?a.transaction.amount:a.entry.amount;return s+i},0),Ve=async t=>{const s=j.length>0?j:Ie?[Ie]:[],a=I;if(s.length===0||a.length===0){o.error("Please select at least one item from each side to match.");return}const i=`match-${Date.now()}`,n=s.map(c=>c.transaction.id),r=a.map(c=>c.entry.id);f(c=>c.filter(y=>!n.includes(y.transaction.id))),b(c=>c.filter(y=>!r.includes(y.entry.id)));const l=[];s.forEach(c=>{l.push({type:"vendor",item:c,markedAt:new Date().toISOString(),status:"matched",resolution:"Matched items",matchGroupId:i})}),a.forEach(c=>{l.push({type:"ap",item:c,markedAt:new Date().toISOString(),status:"matched",resolution:"Matched items",matchGroupId:i})}),v(c=>[...c,...l]);try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/match-items`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,vendorItems:s,apItems:a})})).ok?(o.success(`Successfully matched ${s.length} vendor transaction(s) with ${a.length} AP entry(ies)!`),P(!1),Le(null),O([]),G([])):(o.error("Failed to match items."),f(y=>[...y,...s]),b(y=>[...y,...a]),v(y=>y.filter(C=>C.matchGroupId!==i)))}catch(c){console.error("Failed to match items:",c),o.error("Failed to match items."),f(y=>[...y,...s]),b(y=>[...y,...a]),v(y=>y.filter(C=>C.matchGroupId!==i))}},ve=async(t,s)=>{const a=s==="vendor"?t.transaction.id:t.entry.id;if(!confirm("Are you sure you want to delete this transaction? This action cannot be undone."))return;const i=`delete-${s}-${a}`;S(n=>({...n,[i]:!0})),s==="vendor"?f(n=>n.filter(r=>r.transaction.id!==a)):b(n=>n.filter(r=>r.entry.id!==a));try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/delete-transaction`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:s,item:t})})).ok?o.success("Transaction deleted successfully."):(o.error("Failed to delete transaction."),s==="vendor"?f(r=>[...r,t]):b(r=>[...r,t]))}catch(n){console.error("Failed to delete transaction:",n),o.error("Failed to delete transaction."),s==="vendor"?f(r=>[...r,t]):b(r=>[...r,t])}finally{S(n=>({...n,[i]:!1}))}},ge=async t=>{const s=t.type==="vendor"?t.item.transaction.id:t.item.entry.id;Y(a=>a.filter(i=>(i.type==="vendor"?i.item.transaction.id:i.item.entry.id)!==s)),t.type==="vendor"?f(a=>[...a,t.item]):b(a=>[...a,t.item]);try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/move-to-needs-attention`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:t.type,item:t.item})})).ok?o.success("Moved back to Needs Attention."):(o.error("Failed to move item."),await ye())}catch(a){console.error("Failed to move item:",a),o.error("Failed to move item."),await ye()}},He=async t=>{const s=`unmatch-${t}`;S(r=>({...r,[s]:!0}));const a=x?.pre_matched_items?.find(r=>r.matchGroupId===t);if(!a){o.error("Match group not found."),S(r=>({...r,[s]:!1}));return}W(r=>r&&{...r,pre_matched_items:r.pre_matched_items?.filter(l=>l.matchGroupId!==t)||[]});const i=a.vendorTransactions.map(r=>({transaction:r,suggested_action:"Review this unmatched vendor transaction"})),n=a.apEntries.map(r=>({entry:r,reason:"Unmatched from pre-matched group",action:"Review this unmatched AP entry"}));f(r=>[...r,...i]),b(r=>[...r,...n]);try{const r=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/unmatch-group`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,matchGroupId:t})});if(r.ok)o.success(`Unmatched ${a.vendorTransactions.length} vendor and ${a.apEntries.length} AP transactions. Moved to Needs Attention.`),ie("needs-attention");else{const l=await r.text();console.error("Failed to unmatch group:",r.status,l),o.error("Failed to unmatch group. Please try again."),W(c=>c&&{...c,pre_matched_items:[...c.pre_matched_items||[],a]}),f(c=>c.filter(y=>!i.some(C=>C.transaction.id===y.transaction.id))),b(c=>c.filter(y=>!n.some(C=>C.entry.id===y.entry.id)))}}catch(r){console.error("Failed to unmatch group:",r),o.error("Failed to unmatch group. Please try again."),W(l=>l&&{...l,pre_matched_items:[...l.pre_matched_items||[],a]}),f(l=>l.filter(c=>!i.some(y=>y.transaction.id===c.transaction.id))),b(l=>l.filter(c=>!n.some(y=>y.entry.id===c.entry.id)))}finally{S(r=>({...r,[s]:!1}))}},be=()=>{if(!oe)return[];const t=new Map;return oe.filter(s=>s&&s.item).forEach(s=>{const a=s.matchGroupId||`single-${s.markedAt}`;t.has(a)||t.set(a,[]),t.get(a).push(s)}),Array.from(t.entries()).map(([s,a])=>({groupId:s,items:a}))},We=t=>{qe(s=>{const a=new Set(s);return a.has(t)?a.delete(t):a.add(t),a})};if(R)return e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ce,{className:"size-8 text-gray-400 animate-spin mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Loading AP reconciliation data..."})]})});if(!x)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs(h,{type:"button",variant:"ghost",onClick:De,className:"gap-2",children:[e.jsx(xs,{className:"size-4"}),"Back to Month-End Close"]})}),e.jsxs(Rs,{children:[e.jsx(we,{className:"size-4"}),e.jsxs(Ps,{children:["No AP reconciliation found for ",Se," - ",Ke(k),". Please run an AP reconciliation first."]})]})]});const ze=(xe?.length||0)+(ee?.length||0),$e=H?.length||0,Me=oe?.length||0;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(Is,{}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(h,{type:"button",variant:"ghost",onClick:De,className:"gap-2",children:[e.jsx(xs,{className:"size-4"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl text-gray-900",children:"Review AP Reconciliation"}),e.jsxs("p",{className:"text-gray-500 mt-1",children:[Se," - ",Ke(k)]})]})]})}),Z&&e.jsx("div",{className:"bg-gray-900 text-white p-3 rounded-lg border border-gray-800",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(js,{className:"size-4"}),e.jsxs("p",{className:"text-sm",children:["Period locked Â· Closed ",Oe?.closedAt?new Date(Oe.closedAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):""," Â· Read-only mode"]})]})}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Pre-Matched"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-blue-600",children:x?.pre_matched_items?.length||0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Auto-matched groups"})]})]}),e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Needs Attention"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-red-600",children:ze}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Unmatched items"})]})]}),e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Follow-Up Needed"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-purple-600",children:$e}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Awaiting information"})]})]}),e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Resolved"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-green-600",children:Me}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Completed"})]})]})]}),e.jsxs(Bs,{value:_e,onValueChange:t=>ie(t),className:"space-y-4",children:[e.jsxs(Ls,{children:[e.jsxs(Pe,{value:"needs-attention",className:"gap-2",children:[e.jsx(we,{className:"size-4"}),"Needs Attention",ze>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-red-50 text-red-700 border-red-200",children:ze})]}),e.jsxs(Pe,{value:"follow-up",className:"gap-2",children:[e.jsx(Ne,{className:"size-4"}),"Follow-Up Needed",$e>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-purple-50 text-purple-700 border-purple-200",children:$e})]}),e.jsxs(Pe,{value:"resolved",className:"gap-2",children:[e.jsx(E,{className:"size-4"}),"Resolved / Completed",Me>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-green-50 text-green-700 border-green-200",children:Me})]}),e.jsxs(Pe,{value:"pre-matched",className:"gap-2",children:[e.jsx(he,{className:"size-4"}),"Pre-Matched",(x?.pre_matched_items?.length||0)>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-blue-50 text-blue-700 border-blue-200",children:x?.pre_matched_items?.length||0})]})]}),e.jsxs(Be,{value:"needs-attention",className:"space-y-6",children:[e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(Gs,{className:"size-5 text-red-600"}),"Unmatched Vendor Transactions"]}),e.jsx(pe,{className:"mt-2",children:"These transactions appear in vendor statements but have no matching ledger entries."})]}),e.jsxs(g,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:[xe?.length||0," items"]})]})}),e.jsx(F,{children:xe&&xe.length>0?e.jsx("div",{className:"space-y-3",children:xe.map((t,s)=>e.jsxs("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.transaction.description}),e.jsx(g,{variant:"outline",className:"text-xs",children:t.transaction.date})]}),e.jsxs("p",{className:"text-xs text-gray-600 mb-2",children:[e.jsx("span",{className:"font-medium",children:"Suggested Action:"})," ",t.suggested_action]}),t.suggested_je&&e.jsxs("div",{className:"text-xs bg-white border border-red-200 rounded p-3 mt-2",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-1",children:"AI Suggested Journal Entry:"}),e.jsxs("div",{className:"space-y-1 text-gray-600",children:[e.jsxs("div",{children:["â€¢ Debit: ",t.suggested_je.debit_account]}),e.jsxs("div",{children:["â€¢ Credit: ",t.suggested_je.credit_account]}),e.jsxs("div",{children:["â€¢ Amount: â‚¬",w(t.suggested_je.amount)]})]})]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-lg font-medium mb-2 ${t.transaction.amount>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(t.transaction.amount))]})})]}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t border-red-200",children:[e.jsx(h,{type:"button",size:"sm",className:"gap-2 bg-green-600 hover:bg-green-700",onClick:()=>Ge(t,"vendor"),disabled:Z||K[`approve-vendor-${t.transaction.id}`],children:K[`approve-vendor-${t.transaction.id}`]?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-3 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(vs,{className:"size-3"}),"Approve for JE"]})}),e.jsxs(Qe,{children:[e.jsx(es,{asChild:!0,children:e.jsxs(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",children:[e.jsx(he,{className:"size-3"}),"Match"]})}),e.jsx(ss,{align:"start",className:"w-56",children:e.jsxs(Q,{className:"cursor-pointer",onClick:()=>N(t),children:[e.jsx(he,{className:"size-4 mr-2"}),"Match to AP Entry"]})})]}),e.jsxs(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",onClick:()=>ms(t),disabled:Z,children:[e.jsx(Ns,{className:"size-3"}),"Edit / Correct"]}),e.jsxs(Qe,{modal:!1,children:[e.jsx(es,{asChild:!0,children:e.jsx(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",children:"More Actions"})}),e.jsxs(ss,{align:"end",side:"bottom",sideOffset:8,className:"w-64",children:[e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Ye(t,"vendor"),children:[e.jsx(fs,{className:"size-4 mr-2 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Mark as Timing Difference"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Clears next month/period"})]})]}),e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Xe(t,"vendor"),children:[e.jsx(ys,{className:"size-4 mr-2 text-gray-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Mark as Non-Issue / Ignore"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Reviewed, no action needed"})]})]}),e.jsx(Ze,{}),e.jsxs(Q,{className:"cursor-pointer",onClick:()=>ts(t,"vendor"),children:[e.jsx(Ne,{className:"size-4 mr-2 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Request Information"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Flag for follow-up"})]})]}),e.jsx(Ze,{}),e.jsxs(Q,{className:"cursor-pointer text-red-600",onClick:()=>ve(t,"vendor"),children:[e.jsx(Ss,{className:"size-4 mr-2"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Delete Transaction"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Permanently remove"})]})]})]})]})]})]},s))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"size-12 text-green-500 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"All vendor transactions have been matched!"})]})})]}),e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(ps,{className:"size-5 text-amber-600"}),"Unmatched AP Entries"]}),e.jsx(pe,{className:"mt-2",children:"These entries appear in the AP ledger but have no matching vendor transactions."})]}),e.jsxs(g,{variant:"outline",className:"bg-amber-50 text-amber-700 border-amber-200",children:[ee?.length||0," items"]})]})}),e.jsx(F,{children:ee&&ee.length>0?e.jsx("div",{className:"space-y-3",children:ee.map((t,s)=>e.jsxs("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.entry.description}),e.jsx(g,{variant:"outline",className:"text-xs",children:t.entry.date})]}),e.jsxs("div",{className:"space-y-1 text-xs text-gray-600",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Reason:"})," ",t.reason]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Recommended Action:"})," ",t.action]}),t.entry.account&&e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Account:"})," ",t.entry.account]})]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-lg font-medium ${t.entry.amount>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(t.entry.amount))]})})]}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t border-amber-200",children:[e.jsx(h,{type:"button",size:"sm",variant:"outline",className:"gap-2 bg-purple-50 hover:bg-purple-100 text-purple-700 border-purple-200",onClick:()=>Ee(t),disabled:Z||K[`reverse-ap-${t.entry.id}`],children:K[`reverse-ap-${t.entry.id}`]?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-3 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"size-3"}),"Reverse JE"]})}),e.jsxs(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",onClick:()=>Ue(t),disabled:Z,children:[e.jsx(Ns,{className:"size-3"}),"Edit / Correct"]}),e.jsxs(Qe,{modal:!1,children:[e.jsx(es,{asChild:!0,children:e.jsx(h,{type:"button",size:"sm",variant:"outline",className:"gap-2",children:"More Actions"})}),e.jsxs(ss,{align:"end",side:"bottom",sideOffset:8,className:"w-64",children:[e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Ye(t,"ap"),children:[e.jsx(fs,{className:"size-4 mr-2 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Mark as Timing Difference"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Clears next month/period"})]})]}),e.jsxs(Q,{className:"cursor-pointer",onClick:()=>Xe(t,"ap"),children:[e.jsx(ys,{className:"size-4 mr-2 text-gray-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Mark as Non-Issue / Ignore"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Reviewed, no action needed"})]})]}),e.jsx(Ze,{}),e.jsxs(Q,{className:"cursor-pointer",onClick:()=>ts(t,"ap"),children:[e.jsx(Ne,{className:"size-4 mr-2 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Request Information"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Flag for follow-up"})]})]}),e.jsx(Ze,{}),e.jsxs(Q,{className:"cursor-pointer text-red-600",onClick:()=>ve(t,"ap"),children:[e.jsx(Ss,{className:"size-4 mr-2"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm",children:"Delete Entry"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Permanently remove"})]})]})]})]})]})]},s))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"size-12 text-green-500 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"All AP entries have been matched!"})]})})]})]}),e.jsx(Be,{value:"follow-up",className:"space-y-6",children:e.jsxs(D,{children:[e.jsxs(B,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"size-5 text-purple-600"}),"Items Awaiting Information"]}),e.jsx(pe,{children:"These items have been flagged for follow-up and are awaiting additional information."})]}),e.jsx(F,{children:H&&H.length>0?e.jsx("div",{className:"space-y-3",children:H.map((t,s)=>{const a=t.item,i=t.type==="vendor"?a.transaction:a.entry;return e.jsxs("div",{className:"p-4 bg-purple-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-purple-100 text-purple-700",children:t.type==="vendor"?"Vendor Transaction":"AP Entry"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:i.description}),e.jsx(g,{variant:"outline",className:"text-xs",children:i.date})]}),e.jsxs("div",{className:"bg-white border border-purple-200 rounded p-3 mt-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-900 mb-1",children:"Follow-up Note:"}),e.jsx("p",{className:"text-xs text-gray-600",children:t.note})]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-lg font-medium ${i.amount>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(i.amount))]})})]}),e.jsx("div",{className:"flex gap-2 pt-2 border-t border-purple-200",children:e.jsxs(h,{type:"button",size:"sm",className:"gap-2 bg-blue-600 hover:bg-blue-700",onClick:()=>ge(t),disabled:Z,children:[e.jsx(xs,{className:"size-3"}),"Move to Needs Attention"]})})]},s)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"size-12 text-green-500 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No items awaiting follow-up!"})]})})]})}),e.jsx(Be,{value:"resolved",className:"space-y-6",children:e.jsxs(D,{children:[e.jsxs(B,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"size-5 text-green-600"}),"Resolved Items"]}),e.jsx(pe,{children:"Items that have been resolved, matched, or marked as timing differences/non-issues."})]}),e.jsx(F,{children:oe&&oe.length>0?e.jsx("div",{className:"space-y-3",children:be().map(({groupId:t,items:s})=>{const a=Te.has(t),i=s.length>1;return e.jsxs("div",{className:"border border-green-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:`p-4 bg-green-50 ${i?"cursor-pointer hover:bg-green-100":""}`,onClick:()=>i&&We(t),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(E,{className:"size-5 text-green-600"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[s[0].status==="matched"&&(s.length===2?"Matched Vendor & AP Entry":`Matched ${s.length} Items`),s[0].status==="resolved"&&"Resolved",s[0].status==="timing_difference"&&"Timing Difference",s[0].status==="ignored"&&"Marked as Non-Issue"]}),e.jsx("div",{className:"text-xs text-gray-600 mt-1",children:s[0].status==="matched"?(()=>{const n=s.filter(y=>y.type==="vendor"),r=s.filter(y=>y.type==="ap"),l=n.reduce((y,C)=>{const de=C.type==="vendor"?C.item.transaction:C.item.entry;return y+Math.abs(de.amount)},0),c=r.reduce((y,C)=>{const de=C.type==="vendor"?C.item.transaction:C.item.entry;return y+Math.abs(de.amount)},0);return`${n.length} vendor transaction${n.length!==1?"s":""} (â‚¬${w(l)}) matched with ${r.length} AP entr${r.length!==1?"ies":"y"} (â‚¬${w(c)})`})():s[0].resolution})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(g,{variant:"outline",className:"bg-green-100 text-green-700",children:[s.length," ",s.length===1?"item":"items"]}),i&&(a?e.jsx(_s,{className:"size-4"}):e.jsx(gs,{className:"size-4"}))]})]})}),(a||!i)&&e.jsx("div",{className:"bg-white border-t border-green-200",children:s.map((n,r)=>{const l=n.item,c=n.type==="vendor"?l.transaction:l.entry;return e.jsx("div",{className:`p-3 ${r>0?"border-t border-gray-200":""}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"text-xs",children:n.type==="vendor"?"Vendor":"AP"}),e.jsx("span",{className:"text-sm text-gray-900",children:c.description}),e.jsx("span",{className:"text-xs text-gray-500",children:c.date})]})}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-sm font-medium ${c.amount>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(c.amount))]})})]})},r)})})]},t)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(we,{className:"size-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No resolved items yet."})]})})]})}),e.jsx(Be,{value:"pre-matched",children:e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"size-5 text-blue-600"}),"Pre-Matched Items"]}),e.jsx(pe,{className:"mt-2",children:"Items that were automatically matched during reconciliation. Review and unmatch if needed."})]}),e.jsxs(g,{variant:"outline",className:"bg-blue-50 text-blue-700 border-blue-200",children:[x?.pre_matched_items?.length||0," groups"]})]})}),e.jsx(F,{children:(x?.pre_matched_items?.length||0)>0?e.jsx("div",{className:"space-y-3",children:x?.pre_matched_items?.map((t,s)=>{const a=t.vendorTransactions.reduce((n,r)=>n+Math.abs(r.amount),0),i=t.apEntries.reduce((n,r)=>n+Math.abs(r.amount),0);return e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(he,{className:"size-4 text-blue-600"}),e.jsx(g,{variant:"outline",className:"text-xs bg-blue-100 text-blue-700 border-blue-300",children:"Auto-Matched"}),e.jsxs("span",{className:"text-sm font-medium text-gray-900",children:[t.vendorTransactions.length," Vendor â†” ",t.apEntries.length," AP"]}),e.jsx(g,{variant:"outline",className:"text-xs",children:new Date(t.matchedAt).toLocaleDateString()})]}),e.jsxs("div",{className:"text-xs bg-white border border-blue-200 rounded p-3 mt-2",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:"Match Summary:"}),e.jsxs("div",{className:"space-y-1 text-gray-600",children:[e.jsxs("p",{children:["Vendor Total: â‚¬",w(a)]}),e.jsxs("p",{children:["AP Total: â‚¬",w(i)]}),e.jsxs("p",{className:"text-gray-400 mt-2",children:["Match ID: ",t.matchGroupId]})]})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Vendor Transactions:"}),t.vendorTransactions.map((n,r)=>e.jsx("div",{className:"p-2 bg-white border border-blue-200 rounded text-xs",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-blue-50 text-blue-700",children:"Vendor"}),e.jsx("span",{className:"text-gray-900",children:n.description}),e.jsx("span",{className:"text-gray-500",children:n.date})]}),e.jsxs("span",{className:`font-medium ${n.amount>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(n.amount))]})]})},r))]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700",children:"AP Entries:"}),t.apEntries.map((n,r)=>e.jsx("div",{className:"p-2 bg-white border border-blue-200 rounded text-xs",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-blue-50 text-blue-700",children:"AP"}),e.jsx("span",{className:"text-gray-900",children:n.description}),e.jsx("span",{className:"text-gray-500",children:n.date})]}),e.jsxs("span",{className:`font-medium ${n.amount>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(n.amount))]})]})},r))]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:"text-lg font-medium text-blue-600",children:["â‚¬",w(a)]})})]}),e.jsx("div",{className:"flex gap-2 pt-2 border-t border-blue-200",children:e.jsx(h,{type:"button",size:"sm",variant:"outline",className:"gap-2 bg-red-50 hover:bg-red-100 text-red-700 border-red-200",onClick:()=>He(t.matchGroupId),disabled:Z||K[`unmatch-${t.matchGroupId}`],children:K[`unmatch-${t.matchGroupId}`]?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-3 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"size-3"}),"Unmatch"]})})})]},s)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(he,{className:"size-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No pre-matched items found."})]})})]})})]}),e.jsx(ns,{open:ue,onOpenChange:ne,children:e.jsxs(is,{children:[e.jsxs(ls,{children:[e.jsxs(cs,{children:["Edit ",M==="vendor"?"Vendor Transaction":"AP Entry"]}),e.jsx(os,{children:"Make corrections to the transaction details below."})]}),p&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Re,{htmlFor:"edit-date",children:"Date"}),e.jsx(rs,{id:"edit-date",type:"date",value:p.date,readOnly:!0,disabled:!0,className:"bg-gray-100 cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx(Re,{htmlFor:"edit-description",children:"Description"}),e.jsx(rs,{id:"edit-description",value:p.description,onChange:t=>se({...p,description:t.target.value})})]}),e.jsxs("div",{children:[e.jsx(Re,{htmlFor:"edit-amount",children:"Amount"}),e.jsx(rs,{id:"edit-amount",type:"number",step:"0.01",value:p.amount,readOnly:!0,disabled:!0,className:"bg-gray-100 cursor-not-allowed"})]})]}),e.jsxs(ds,{children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>ne(!1),children:"Cancel"}),e.jsx(h,{type:"button",onClick:Je,children:"Save Changes"})]})]})}),e.jsx(ns,{open:Ae,onOpenChange:me,children:e.jsxs(is,{className:"max-w-[600px]",children:[e.jsxs(ls,{children:[e.jsxs(cs,{className:"flex items-center gap-2 text-xl",children:[e.jsx(Ne,{className:"size-5 text-purple-600"}),"Request Information"]}),e.jsx(os,{className:"text-gray-600",children:"Add a note about what information is needed for this transaction."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Re,{className:"text-sm font-medium text-gray-700 mb-2",children:"What information do you need?"}),e.jsx(Es,{value:u,onChange:t=>_(t.target.value),placeholder:"e.g., Need vendor invoice from supplier, Waiting for client approval, Need clarification on purpose...",rows:5,className:"mt-2 resize-none"})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-start gap-2 mb-3",children:[e.jsx(vs,{className:"size-4 text-purple-600 mt-0.5"}),e.jsx("span",{className:"text-sm font-medium text-purple-900",children:"Common follow-ups:"})]}),e.jsxs("ul",{className:"space-y-2 ml-6",children:[e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Vendor invoice required"]}),e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Client inquiry needed"]}),e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"AP statement clarification"]}),e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Team member approval required"]})]})]})]}),e.jsxs(ds,{className:"gap-2",children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>me(!1),children:"Cancel"}),e.jsx(h,{type:"button",onClick:d,className:"bg-purple-600 hover:bg-purple-700",children:"Flag for Follow-Up"})]})]})}),e.jsx(ns,{open:U,onOpenChange:P,children:e.jsxs(is,{className:"max-w-[90vw] w-[1600px] max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs(ls,{children:[e.jsx(cs,{children:"Match Transactions - Multi-Select"}),e.jsx(os,{children:"Select one or more vendor transactions and one or more AP entries to match them together. Supports many-to-many matching."})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"sticky top-0 bg-white pb-3 border-b border-gray-200 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(ks,{className:"size-4 text-red-600"}),"Vendor Transactions"]}),e.jsxs(g,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:[j.length," selected"]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded p-3",children:[e.jsx("div",{className:"text-sm font-medium text-blue-900",children:"Selected Total:"}),e.jsxs("div",{className:`text-2xl font-medium ${le(j)>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(le(j)))]})]})]}),e.jsx("div",{className:"space-y-2",children:xe&&xe.map((t,s)=>{const a=j.some(i=>i.transaction.id===t.transaction.id);return e.jsx("div",{className:`p-3 rounded-lg border-2 transition-all cursor-pointer ${a?"bg-blue-100 border-blue-500 shadow-md":"bg-red-50 border-red-200 hover:border-red-400"}`,onClick:()=>q(t),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(bs,{checked:a,onCheckedChange:()=>q(t),className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.transaction.description}),e.jsxs("div",{className:`text-lg font-medium ${t.transaction.amount>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(t.transaction.amount))]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:t.transaction.date})]})]})},s)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"sticky top-0 bg-white pb-3 border-b border-gray-200 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(ps,{className:"size-4 text-amber-600"}),"AP Entries"]}),e.jsxs(g,{variant:"outline",className:"bg-amber-50 text-amber-700 border-amber-200",children:[I.length," selected"]})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded p-3",children:[e.jsx("div",{className:"text-sm font-medium text-purple-900",children:"Selected Total:"}),e.jsxs("div",{className:`text-2xl font-medium ${le(I)>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(le(I)))]})]})]}),e.jsx("div",{className:"space-y-2",children:ee&&ee.map((t,s)=>{const a=I.some(i=>i.entry.id===t.entry.id);return e.jsx("div",{className:`p-3 rounded-lg border-2 transition-all cursor-pointer ${a?"bg-purple-100 border-purple-500 shadow-md":"bg-amber-50 border-amber-200 hover:border-amber-400"}`,onClick:()=>J(t),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(bs,{checked:a,onCheckedChange:()=>J(t),className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t.entry.description}),e.jsxs("div",{className:`text-lg font-medium ${t.entry.amount>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",w(Math.abs(t.entry.amount))]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:t.entry.date})]})]})},s)})})]})]})}),(j.length>0||I.length>0)&&e.jsx("div",{className:"border-t border-gray-200 pt-4",children:e.jsx("div",{className:`p-4 rounded-lg border-2 ${Math.abs(le(j)-le(I))<.01?"bg-green-50 border-green-500":"bg-yellow-50 border-yellow-500"}`,children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 mb-1",children:Math.abs(le(j)-le(I))<.01?e.jsxs("span",{className:"text-green-700 flex items-center gap-2",children:[e.jsx(E,{className:"size-5"}),"Amounts Match - Ready to Reconcile"]}):e.jsxs("span",{className:"text-yellow-700 flex items-center gap-2",children:[e.jsx(we,{className:"size-5"}),"Amount Difference"]})}),e.jsxs("div",{className:"text-sm text-gray-600",children:["Vendor: â‚¬",w(Math.abs(le(j)))," | AP: â‚¬",w(Math.abs(le(I)))," | Diff: â‚¬",w(Math.abs(le(j)-le(I)))]})]})})})}),e.jsxs(ds,{children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>P(!1),children:"Cancel"}),e.jsx(h,{type:"button",onClick:()=>Ve(),disabled:Z||j.length===0||I.length===0,children:"Match Selected Items"})]})]})})]})}function et({companyId:T,companyName:Se,period:k,onBack:De}){const[x,W]=m.useState(null),[R,ke]=m.useState(!1),[ue,ne]=m.useState("needs-attention"),[Ae,me]=m.useState(!1),[Fe,je]=m.useState(!1),[ae,fe]=m.useState(null),[u,_]=m.useState(null),[_e,ie]=m.useState(null),[p,se]=m.useState(null),[M,te]=m.useState(""),[U,P]=m.useState({}),[Ie,Le]=m.useState(new Set),[j,O]=m.useState([]),[I,G]=m.useState([]),[K,S]=m.useState([]),[Te,qe]=m.useState([]),[xe,f]=m.useState(!1),[ee,b]=m.useState([]),[oe,v]=m.useState([]),[H,Y]=m.useState(!1),[Z,hs]=m.useState(null);m.useEffect(()=>{Oe(),Ce()},[T,k]);const Oe=async()=>{try{const s=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/month-close/status?companyId=${T}&period=${k}`,{headers:{Authorization:`Bearer ${$}`}});if(s.ok){const a=await s.json();Y(a.isLocked||!1),hs(a.isLocked?a:null),console.log("Period lock status:",a)}}catch(s){console.error("Failed to load lock status:",s)}},Ce=async()=>{ke(!0);try{const s=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/cc-rec/reconciliation?companyId=${T}&period=${k}`,{headers:{Authorization:`Bearer ${$}`}});if(s.ok){const a=await s.json();console.log("CC Reconciliation data loaded:",a);const i=a.reconciliation||a;i.matched_pairs&&(!i.pre_matched_items||i.pre_matched_items.length===0)&&(console.log("Converting matched_pairs to pre_matched_items..."),i.pre_matched_items=i.matched_pairs.map((n,r)=>({matchGroupId:`cc-match-${Date.now()}-${r}`,ccTransactions:Array.isArray(n.cc_transaction)?n.cc_transaction:[n.cc_transaction],ledgerEntries:Array.isArray(n.ledger_entries)?n.ledger_entries:[n.ledger_entries],matchedAt:i.reconciled_at||new Date().toISOString(),confidence:n.match_confidence||100,matchType:n.match_type||"exact",explanation:n.explanation||"Matched by AI"}))),W(i),O(i.unmatched_cc||[]),G(i.unmatched_ledger||[]),S(i.resolved_items||[]),qe(i.follow_up_items||[])}else if(s.status===404)console.log("No CC reconciliation found for this period (not yet run)"),W(null);else{const a=await s.text();console.error("Failed to load CC reconciliation data:",s.status,a),W(null)}}catch(s){console.error("Failed to load CC reconciliation data:",s),W(null)}finally{ke(!1)}},X=s=>s.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}),ye=s=>{const[a,i]=s.split("-");return new Date(parseInt(a),parseInt(i)-1,1).toLocaleDateString("en-US",{month:"long",year:"numeric"})},w=s=>s.debit!==void 0?s.debit||0:s.amount||0,Ke=s=>s.vendor?s.vendor:s.description||"No description",ms=(s,a)=>{a==="cc"?(fe({...s.transaction}),ie(s),se(null)):(fe({...s.entry}),se(s),ie(null)),_(a),me(!0)},Ue=async()=>{ae&&(u==="cc"&&ae?O(s=>s.map(a=>a.transaction.id===ae.id?{...a,transaction:{...a.transaction,...ae}}:a)):u==="ledger"&&ae&&G(s=>s.map(a=>a.entry.id===ae.id?{...a,entry:{...a.entry,...ae}}:a)),me(!1),o.success("Transaction updated successfully!"))},Je=async(s,a)=>{const i=s.transaction.id,n=`approve-${a}-${i}`;P(r=>({...r,[n]:!0})),O(r=>r.filter(l=>l.transaction.id!==i)),S(r=>[...r,{type:"cc",item:s,markedAt:new Date().toISOString(),status:"resolved",resolution:"Transaction sent to Journal Entries section to be recorded"}]);try{const r=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/journal-entries/approve-suggestion`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:a,item:s,source:"cc-rec"})});if(r.ok)console.log("CC transaction approved for AI journal entry generation"),o.success("Transaction approved! AI will generate a suggested journal entry in the Draft/Suggested tab.");else{const l=await r.text();console.error("Failed to approve CC transaction:",r.status,l),o.error("Failed to approve transaction. Please try again."),await Ce()}}catch(r){console.error("Error approving CC transaction:",r),o.error("Network error. Please check your connection and try again."),await Ce()}finally{P(r=>({...r,[n]:!1}))}},Ge=async s=>{const a=s.entry.id,i=`reverse-ledger-${a}`;P(n=>({...n,[i]:!0})),G(n=>n.filter(r=>r.entry.id!==a)),S(n=>[...n,{type:"ledger",item:s,markedAt:new Date().toISOString(),status:"resolved",resolution:"Reversing journal entry sent to Journal Entries section"}]);try{const n=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/journal-entries/reverse-je`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,item:s})});if(n.ok)console.log("Ledger entry marked for reversal"),o.success("Reversing JE sent to Journal Entries section!");else{const r=await n.text();console.error("Failed to reverse ledger entry:",n.status,r),o.error("Failed to reverse entry. Please try again."),await Ce()}}catch(n){console.error("Error reversing ledger entry:",n),o.error("Network error. Please check your connection and try again."),await Ce()}finally{P(n=>({...n,[i]:!1}))}},Ee=(s,a)=>{a==="cc"?(ie(s),se(null)):(se(s),ie(null)),_(a),te(""),je(!0)},Ye=async()=>{if(!M.trim()){alert("Please enter a note about what information is needed.");return}const s=_e||p,a=u,i=a==="cc"?s?.transaction.id:s?.entry.id;a==="cc"&&s?(O(n=>n.filter(r=>r.transaction.id!==i)),qe(n=>[...n,{item:s,type:"cc",note:M,markedAt:new Date().toISOString()}])):a==="ledger"&&s&&(G(n=>n.filter(r=>r.entry.id!==i)),qe(n=>[...n,{item:s,type:"ledger",note:M,markedAt:new Date().toISOString()}])),je(!1);try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/cc-rec/request-information`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:a,item:s,note:M})})).ok?o.success("Item added to Follow-Up. You can provide more information later."):(o.error("Failed to save follow-up item."),await Ce())}catch(n){console.error("Failed to request information:",n),o.error("Failed to save follow-up item."),await Ce()}},Xe=async(s,a)=>{const i=a==="cc"?s.transaction.id:s.entry.id,n=`timing-${a}-${i}`;P(r=>({...r,[n]:!0})),a==="cc"?(O(r=>r.filter(l=>l.transaction.id!==i)),S(r=>[...r,{type:"cc",item:s,markedAt:new Date().toISOString(),status:"timing_difference",resolution:"Will clear next period",matchGroupId:`timing-${i}`}])):(G(r=>r.filter(l=>l.entry.id!==i)),S(r=>[...r,{type:"ledger",item:s,markedAt:new Date().toISOString(),status:"timing_difference",resolution:"Will clear next period",matchGroupId:`timing-${i}`}]));try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/cc-rec/mark-timing-difference`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:a,item:s})})).ok?o.success("Marked as timing difference. Will clear next period."):(o.error("Failed to mark as timing difference."),a==="cc"?(O(l=>[...l,s]),S(l=>l.filter(c=>c.matchGroupId!==`timing-${i}`))):(G(l=>[...l,s]),S(l=>l.filter(c=>c.matchGroupId!==`timing-${i}`))))}catch(r){console.error("Failed to mark as timing difference:",r),o.error("Failed to mark as timing difference."),a==="cc"?(O(l=>[...l,s]),S(l=>l.filter(c=>c.matchGroupId!==`timing-${i}`))):(G(l=>[...l,s]),S(l=>l.filter(c=>c.matchGroupId!==`timing-${i}`)))}finally{P(r=>({...r,[n]:!1}))}},ts=async(s,a)=>{const i=a==="cc"?s.transaction.id:s.entry.id,n=`ignore-${a}-${i}`;P(r=>({...r,[n]:!0})),a==="cc"?(O(r=>r.filter(l=>l.transaction.id!==i)),S(r=>[...r,{type:"cc",item:s,markedAt:new Date().toISOString(),status:"ignored",resolution:"Marked as non-issue",matchGroupId:`ignored-${i}`}])):(G(r=>r.filter(l=>l.entry.id!==i)),S(r=>[...r,{type:"ledger",item:s,markedAt:new Date().toISOString(),status:"ignored",resolution:"Marked as non-issue",matchGroupId:`ignored-${i}`}]));try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/cc-rec/mark-ignored`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,type:a,item:s})})).ok?o.success("Marked as non-issue. Will not appear again."):(o.error("Failed to mark as ignored."),a==="cc"?(O(l=>[...l,s]),S(l=>l.filter(c=>c.matchGroupId!==`ignored-${i}`))):(G(l=>[...l,s]),S(l=>l.filter(c=>c.matchGroupId!==`ignored-${i}`))))}catch(r){console.error("Failed to mark as ignored:",r),o.error("Failed to mark as ignored."),a==="cc"?(O(l=>[...l,s]),S(l=>l.filter(c=>c.matchGroupId!==`ignored-${i}`))):(G(l=>[...l,s]),S(l=>l.filter(c=>c.matchGroupId!==`ignored-${i}`)))}finally{P(r=>({...r,[n]:!1}))}},d=async s=>{const a=s.matchGroupId;if(a){const i=K.filter(n=>n.matchGroupId===a);S(n=>n.filter(r=>r.matchGroupId!==a)),i.forEach(n=>{n.type==="cc"?O(r=>[...r,n.item]):G(r=>[...r,n.item])}),o.success("Match group unmatched. All items restored to Needs Attention.")}else S(i=>i.filter(n=>n!==s)),s.type==="cc"?O(i=>[...i,s.item]):G(i=>[...i,s.item]),o.success("Item moved back to Needs Attention.")},N=async s=>{qe(a=>a.filter(i=>i!==s)),s.type==="cc"?O(a=>[...a,s.item]):G(a=>[...a,s.item]),o.success("Item moved back to Needs Attention.")},q=async s=>{const a=`unmatch-${s.matchGroupId}`;P(r=>({...r,[a]:!0})),W(r=>r&&{...r,pre_matched_items:r.pre_matched_items?.filter(l=>l.matchGroupId!==s.matchGroupId)||[]});const i=s.ccTransactions.map(r=>({transaction:r,suggested_action:"Review this unmatched CC transaction"})),n=s.ledgerEntries.map(r=>({entry:r,reason:"Previously matched, now unmatched",action:"Review and re-match if needed"}));O(r=>[...r,...i]),G(r=>[...r,...n]),o.success(`Unmatched group with ${s.ccTransactions.length} CC transaction(s) and ${s.ledgerEntries.length} ledger entry(ies).`),P(r=>({...r,[a]:!1}))},J=s=>{b([s]),v([]),f(!0)},le=s=>{b(a=>a.some(n=>n.transaction.id===s.transaction.id)?a.filter(n=>n.transaction.id!==s.transaction.id):[...a,s])},Ve=s=>{v(a=>a.some(n=>n.entry.id===s.entry.id)?a.filter(n=>n.entry.id!==s.entry.id):[...a,s])},ve=()=>ee.reduce((s,a)=>s+a.transaction.amount,0),ge=()=>oe.reduce((s,a)=>s+w(a.entry),0),He=()=>{if(!K)return[];console.log("groupResolvedItems - All resolved items:",K);const s=new Map;K.filter(i=>i&&i.item).forEach(i=>{const n=i.matchGroupId||`single-${i.markedAt}`;console.log(`Item with matchGroupId: ${i.matchGroupId}, status: ${i.status}, groupId: ${n}`),s.has(n)||s.set(n,[]),s.get(n).push(i)});const a=Array.from(s.entries()).map(([i,n])=>({groupId:i,items:n}));return console.log("groupResolvedItems - Grouped result:",a),a},be=s=>{Le(a=>{const i=new Set(a);return i.has(s)?i.delete(s):i.add(s),i})},We=async()=>{const s=ee,a=oe,i=`match-${Date.now()}`;O(r=>r.filter(l=>!s.some(c=>c.transaction.id===l.transaction.id))),G(r=>r.filter(l=>!a.some(c=>c.entry.id===l.entry.id)));const n=[];s.forEach(r=>{n.push({type:"cc",item:r,markedAt:new Date().toISOString(),status:"matched",resolution:"Matched items",matchGroupId:i})}),a.forEach(r=>{n.push({type:"ledger",item:r,markedAt:new Date().toISOString(),status:"matched",resolution:"Matched items",matchGroupId:i})}),S(r=>[...r,...n]);try{(await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/cc-rec/match-items`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:T,period:k,ccItems:s.map(l=>l.transaction),ledgerItems:a.map(l=>l.entry)})})).ok?(o.success(`Successfully matched ${s.length} CC transaction(s) with ${a.length} ledger entry(ies)!`),f(!1),b([]),v([])):(o.error("Failed to match items."),O(l=>[...l,...s]),G(l=>[...l,...a]),S(l=>l.filter(c=>!n.includes(c))))}catch(r){console.error("Failed to match items:",r),o.error("Failed to match items."),O(l=>[...l,...s]),G(l=>[...l,...a]),S(l=>l.filter(c=>!n.includes(c)))}};if(R)return e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ce,{className:"size-8 text-gray-400 animate-spin mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Loading CC reconciliation data..."})]})});if(!x)return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs(h,{type:"button",variant:"ghost",onClick:De,className:"gap-2",children:[e.jsx(xs,{className:"size-4"}),"Back to Month-End Close"]})}),e.jsxs(Rs,{children:[e.jsx(we,{className:"size-4"}),e.jsxs(Ps,{children:["No CC reconciliation found for ",Se," - ",ye(k),". Please run a credit card reconciliation first."]})]})]});const ze=(j?.length||0)+(I?.length||0),$e=Te?.length||0,Me=K?.length||0,t=x?.pre_matched_items?.filter(s=>s.matchType!=="manual").length||0;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(Is,{position:"bottom-right"}),e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(h,{type:"button",variant:"ghost",onClick:De,className:"gap-2",children:[e.jsx(xs,{className:"size-4"}),"Back"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl text-gray-900",children:"Review CC Reconciliation"}),e.jsxs("p",{className:"text-gray-500 mt-1",children:[Se," - ",ye(k)]})]})]})}),H&&e.jsx("div",{className:"bg-gray-900 text-white p-3 rounded-lg border border-gray-800",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(js,{className:"size-4"}),e.jsxs("p",{className:"text-sm",children:["Period locked Â· Closed ",Z?.closedAt?new Date(Z.closedAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):""," Â· Read-only mode"]})]})}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Pre-Matched"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-blue-600",children:t}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Auto-matched groups"})]})]}),e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Needs Attention"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-red-600",children:ze}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Unmatched items"})]})]}),e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Follow-Up Needed"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-purple-600",children:$e}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Awaiting information"})]})]}),e.jsxs(D,{children:[e.jsx(B,{className:"pb-3",children:e.jsx(L,{className:"text-sm text-gray-600",children:"Resolved"})}),e.jsxs(F,{children:[e.jsx("div",{className:"text-2xl text-green-600",children:Me}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Completed"})]})]})]}),e.jsxs(Bs,{value:ue,onValueChange:s=>ne(s),className:"space-y-4",children:[e.jsxs(Ls,{children:[e.jsxs(Pe,{value:"needs-attention",className:"gap-2",children:[e.jsx(we,{className:"size-4"}),"Needs Attention",ze>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-red-50 text-red-700 border-red-200",children:ze})]}),e.jsxs(Pe,{value:"follow-up",className:"gap-2",children:[e.jsx(Ne,{className:"size-4"}),"Follow-Up Needed",$e>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-purple-50 text-purple-700 border-purple-200",children:$e})]}),e.jsxs(Pe,{value:"resolved",className:"gap-2",children:[e.jsx(E,{className:"size-4"}),"Resolved / Completed",Me>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-green-50 text-green-700 border-green-200",children:Me})]}),e.jsxs(Pe,{value:"pre-matched",className:"gap-2",children:[e.jsx(he,{className:"size-4"}),"Pre-Matched",t>0&&e.jsx(g,{variant:"outline",className:"ml-1 bg-blue-50 text-blue-700 border-blue-200",children:t})]})]}),e.jsxs(Be,{value:"needs-attention",className:"space-y-6",children:[e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(Ms,{className:"size-5 text-red-600"}),"Unmatched Credit Card Transactions"]}),e.jsx(pe,{className:"mt-2",children:"These transactions appear in credit card statements but have no matching ledger entries."})]}),e.jsxs(g,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:[j.length," items"]})]})}),e.jsx(F,{children:j&&j.length>0?e.jsx("div",{className:"space-y-3",children:j.map((s,a)=>e.jsxs("div",{className:"p-4 bg-red-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-gray-900",children:s.transaction.description}),e.jsx("span",{className:"text-xs text-gray-500",children:s.transaction.date})]}),s.transaction.merchant&&e.jsxs("p",{className:"text-xs text-gray-600",children:["Merchant: ",s.transaction.merchant]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Suggested Action: ",s.suggested_action]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-2xl font-medium ${s.transaction.amount<0?"text-red-600":"text-green-600"}`,children:["â‚¬",X(Math.abs(s.transaction.amount))]})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{size:"sm",className:"gap-1 bg-green-600 hover:bg-green-700 text-white",onClick:()=>Je(s,"cc"),disabled:H,children:[e.jsx(vs,{className:"size-3.5"}),"Approve for JE"]}),e.jsxs(h,{size:"sm",variant:"outline",className:"gap-1 bg-white",onClick:()=>J(s),disabled:H,children:[e.jsx(he,{className:"size-3.5"}),"Match"]}),e.jsxs(h,{size:"sm",variant:"outline",className:"gap-1 bg-white",onClick:()=>ms(s,"cc"),disabled:H,children:[e.jsx(Ns,{className:"size-3.5"}),"Edit / Correct"]}),e.jsxs(Qe,{modal:!1,children:[e.jsx(es,{asChild:!0,children:e.jsxs(h,{size:"sm",variant:"outline",className:"gap-1 bg-white",disabled:H,children:["More Actions",e.jsx(gs,{className:"size-3.5"})]})}),e.jsxs(ss,{align:"end",children:[e.jsxs(Q,{onClick:()=>Ee(s,"cc"),children:[e.jsx(Ne,{className:"size-4 mr-2"}),"Request Information"]}),e.jsxs(Q,{onClick:()=>Xe(s,"cc"),children:[e.jsx(fs,{className:"size-4 mr-2"}),"Mark as Timing Difference"]}),e.jsx(Ze,{}),e.jsxs(Q,{onClick:()=>ts(s,"cc"),children:[e.jsx(ys,{className:"size-4 mr-2"}),"Mark as Non-Issue"]})]})]})]})]},a))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"size-12 text-green-500 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"All credit card transactions have been matched!"})]})})]}),e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(ps,{className:"size-5 text-amber-600"}),"Unmatched Ledger Entries"]}),e.jsx(pe,{className:"mt-2",children:"These entries appear in the general ledger but have no matching credit card transactions."})]}),e.jsxs(g,{variant:"outline",className:"bg-amber-50 text-amber-700 border-amber-200",children:[I.length," items"]})]})}),e.jsx(F,{children:I&&I.length>0?e.jsx("div",{className:"space-y-3",children:I.map((s,a)=>e.jsxs("div",{className:"p-4 bg-amber-50 border border-amber-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-gray-900",children:Ke(s.entry)}),e.jsx("span",{className:"text-xs text-gray-500",children:s.entry.date})]}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Suggested Action: ",s.action]}),(s.entry.glAccount||s.entry.account)&&e.jsxs("p",{className:"text-xs text-gray-600",children:["Account: ",s.entry.glAccount||s.entry.account]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:`text-2xl font-medium ${w(s.entry)<0?"text-green-600":"text-red-600"}`,children:["â‚¬",X(Math.abs(w(s.entry)))]})})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",className:"gap-1 bg-purple-50 hover:bg-purple-100 text-purple-700 border-purple-200",onClick:()=>Ge(s),disabled:H||U[`reverse-ledger-${s.entry.id}`],children:U[`reverse-ledger-${s.entry.id}`]?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-3.5 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"size-3.5"}),"Reverse JE"]})}),e.jsxs(h,{size:"sm",variant:"outline",className:"gap-1 bg-white",onClick:()=>J(s),disabled:H,children:[e.jsx(he,{className:"size-3.5"}),"Match"]}),e.jsxs(h,{size:"sm",variant:"outline",className:"gap-1 bg-white",onClick:()=>ms(s,"ledger"),disabled:H,children:[e.jsx(Ns,{className:"size-3.5"}),"Edit / Correct"]}),e.jsxs(Qe,{modal:!1,children:[e.jsx(es,{asChild:!0,children:e.jsxs(h,{size:"sm",variant:"outline",className:"gap-1 bg-white",disabled:H,children:["More Actions",e.jsx(gs,{className:"size-3.5"})]})}),e.jsxs(ss,{align:"end",children:[e.jsxs(Q,{onClick:()=>Ee(s,"ledger"),children:[e.jsx(Ne,{className:"size-4 mr-2"}),"Request Information"]}),e.jsxs(Q,{onClick:()=>Xe(s,"ledger"),children:[e.jsx(fs,{className:"size-4 mr-2"}),"Mark as Timing Difference"]}),e.jsx(Ze,{}),e.jsxs(Q,{onClick:()=>ts(s,"ledger"),children:[e.jsx(ys,{className:"size-4 mr-2"}),"Mark as Non-Issue"]})]})]})]})]},a))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"size-12 text-green-500 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"All ledger entries have been matched!"})]})})]})]}),e.jsx(Be,{value:"follow-up",className:"space-y-6",children:e.jsxs(D,{children:[e.jsxs(B,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"size-5 text-purple-600"}),"Items Awaiting Information"]}),e.jsx(pe,{className:"mt-2",children:"These items require additional information from your team before they can be resolved."})]}),e.jsx(F,{children:Te&&Te.length>0?e.jsx("div",{className:"space-y-3",children:Te.map((s,a)=>{const i=s.item,n=s.type==="cc",r=n?i.transaction:i.entry;return e.jsxs("div",{className:"p-4 bg-purple-50 border border-purple-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-gray-900",children:r.description}),e.jsx("span",{className:"text-xs text-gray-500",children:r.date}),e.jsx(g,{variant:"outline",className:"bg-purple-100 text-purple-700 border-purple-300 text-xs",children:n?"CC Transaction":"Ledger Entry"})]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-2",children:[e.jsx("span",{className:"font-medium",children:"Follow-up Note:"})," ",s.note]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Added on ",new Date(s.markedAt).toLocaleDateString()]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:"text-lg font-medium text-gray-900",children:["â‚¬",X(Math.abs(r.amount))]})})]}),e.jsx("div",{className:"flex items-center gap-2 pt-3 border-t border-purple-200",children:e.jsxs(h,{size:"sm",variant:"outline",className:"gap-1",onClick:()=>N(s),disabled:H,children:[e.jsx(as,{className:"size-3.5"}),"Move Back to Needs Attention"]})})]},a)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(Ne,{className:"size-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No items waiting for follow-up."})]})})]})}),e.jsx(Be,{value:"resolved",className:"space-y-6",children:e.jsxs(D,{children:[e.jsxs(B,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(E,{className:"size-5 text-green-600"}),"Resolved Items"]}),e.jsx(pe,{className:"mt-2",children:"These items have been resolved and no longer require attention."})]}),e.jsx(F,{children:K&&K.length>0?e.jsx("div",{className:"space-y-3",children:He().map((s,a)=>{const{groupId:i,items:n}=s,r=Ie.has(i),l=n[0]?.matchGroupId&&n[0]?.status==="matched",c=n.filter(A=>A&&A.item&&A.type==="cc"),y=n.filter(A=>A&&A.item&&A.type==="ledger"),C=c.reduce((A,V)=>{if(!V?.item)return A;const re=V.item?.transaction;return re?A+Math.abs(re.amount):A},0),de=y.reduce((A,V)=>{if(!V?.item)return A;const re=V.item?.entry;return re?A+Math.abs(w(re)):A},0);if(l)return e.jsxs("div",{className:"p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(E,{className:"size-4 text-green-600"}),e.jsx(g,{variant:"outline",className:"text-xs bg-green-100 text-green-700 border-green-300",children:"Matched Group"}),e.jsx("span",{className:"text-xs text-gray-500",children:n[0].markedAt&&new Date(n[0].markedAt).toLocaleDateString()})]}),e.jsxs("div",{className:"text-sm text-gray-900",children:[e.jsx("strong",{children:c.length})," CC transaction(s) matched with ",e.jsx("strong",{children:y.length})," ledger entry(ies)"]}),e.jsxs("div",{className:"flex items-center gap-4 mt-2 text-xs",children:[e.jsxs("span",{className:"text-red-600",children:["CC Total: â‚¬",X(C)]}),e.jsxs("span",{className:"text-amber-600",children:["Ledger Total: â‚¬",X(de)]}),Math.abs(C-de)<.01&&e.jsx(g,{className:"bg-green-600 text-white",children:"Perfect Match"})]})]}),e.jsxs(h,{size:"sm",variant:"ghost",onClick:()=>be(i),className:"gap-1",children:[r?e.jsx(_s,{className:"size-4"}):e.jsx(gs,{className:"size-4"}),r?"Collapse":"Expand"]})]}),r&&e.jsxs("div",{className:"mt-4 grid grid-cols-2 gap-4 pt-4 border-t border-green-300",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-medium text-gray-700 mb-2 flex items-center gap-1",children:[e.jsx(Ms,{className:"size-3 text-red-600"}),"CC Transactions"]}),e.jsx("div",{className:"space-y-2",children:c.map((A,V)=>{const re=A.item.transaction;return e.jsxs("div",{className:"p-2 bg-white rounded border border-red-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium",children:re.description}),e.jsxs("span",{className:"text-xs text-red-600 font-medium",children:["â‚¬",X(Math.abs(re.amount))]})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:re.date})]},V)})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"text-xs font-medium text-gray-700 mb-2 flex items-center gap-1",children:[e.jsx(ps,{className:"size-3 text-amber-600"}),"Ledger Entries"]}),e.jsx("div",{className:"space-y-2",children:y.map((A,V)=>{const re=A.item.entry;return e.jsxs("div",{className:"p-2 bg-white rounded border border-amber-200",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs font-medium",children:Ke(re)}),e.jsxs("span",{className:"text-xs text-amber-600 font-medium",children:["â‚¬",X(Math.abs(w(re)))]})]}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:re.date})]},V)})})]})]}),e.jsx("div",{className:"flex items-center gap-2 pt-3 border-t border-green-300 mt-3",children:e.jsxs(h,{size:"sm",variant:"outline",className:"gap-1",onClick:()=>d(n[0]),disabled:H,children:[e.jsx(as,{className:"size-3.5"}),"Unmatch & Restore"]})})]},a);{const A=n[0],V=A.item,zs=A.type==="cc"?V.transaction:V.entry,Os=A.status==="timing_difference"?"bg-blue-50":A.status==="ignored"?"bg-gray-50":"bg-green-50",Us=A.status==="timing_difference"?"border-blue-200":A.status==="ignored"?"border-gray-200":"border-green-200";return e.jsxs("div",{className:`p-4 ${Os} border ${Us} rounded-lg`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-gray-900",children:zs.description}),e.jsx("span",{className:"text-xs text-gray-500",children:zs.date}),e.jsx(g,{variant:"outline",className:"text-xs",children:A.status.replace("_"," ")})]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:[e.jsx("span",{className:"font-medium",children:"Resolution:"})," ",A.resolution]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Resolved on ",new Date(A.markedAt).toLocaleDateString()]})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:"text-lg font-medium text-gray-900",children:["â‚¬",X(Math.abs(zs.amount))]})})]}),e.jsx("div",{className:"flex items-center gap-2 pt-3 border-t border-gray-200",children:e.jsxs(h,{size:"sm",variant:"outline",className:"gap-1",onClick:()=>d(A),disabled:H,children:[e.jsx(as,{className:"size-3.5"}),"Undo Resolution"]})})]},a)}})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(E,{className:"size-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No resolved items yet."})]})})]})}),e.jsx(Be,{value:"pre-matched",className:"space-y-6",children:e.jsxs(D,{children:[e.jsxs(B,{children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"size-5 text-blue-600"}),"Pre-Matched Groups"]}),e.jsx(pe,{className:"mt-2",children:"These transactions were automatically matched by our AI during reconciliation."})]}),e.jsx(F,{children:x?.pre_matched_items&&x.pre_matched_items.filter(s=>s.matchType!=="manual").length>0?e.jsx("div",{className:"space-y-4",children:x.pre_matched_items.filter(s=>s.matchType!=="manual").map((s,a)=>{const i=Ie.has(s.matchGroupId),n=s.ccTransactions.reduce((l,c)=>l+Math.abs(c.amount),0),r=s.ledgerEntries.reduce((l,c)=>l+Math.abs(w(c)),0);return e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3 cursor-pointer",onClick:()=>{const l=new Set(Ie);i?l.delete(s.matchGroupId):l.add(s.matchGroupId),Le(l)},children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[i?e.jsx(_s,{className:"size-4 text-blue-600"}):e.jsx(gs,{className:"size-4 text-blue-600"}),e.jsx(E,{className:"size-4 text-blue-600"}),e.jsx(g,{variant:"outline",className:"text-xs bg-blue-100 text-blue-700 border-blue-300",children:s.matchType||"Matched"}),e.jsxs("span",{className:"text-sm font-medium text-gray-900",children:[s.ccTransactions.length," CC â†” ",s.ledgerEntries.length," Ledger"]}),e.jsx(g,{variant:"outline",className:"text-xs",children:new Date(s.matchedAt).toLocaleDateString()}),s.confidence&&e.jsxs(g,{variant:"outline",className:"text-xs bg-green-50 text-green-700",children:[s.confidence,"% confidence"]})]}),!i&&s.explanation&&e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:s.explanation})]}),e.jsx("div",{className:"ml-4",children:e.jsxs("div",{className:"text-lg font-medium text-blue-600",children:["â‚¬",X(n)]})})]}),i&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"text-xs bg-white border border-blue-200 rounded p-3 mb-3",children:[e.jsx("div",{className:"font-medium text-gray-900 mb-2",children:"Match Summary:"}),e.jsxs("div",{className:"space-y-1 text-gray-600",children:[e.jsxs("p",{children:["CC Total: â‚¬",X(n)]}),e.jsxs("p",{children:["Ledger Total: â‚¬",X(r)]}),s.explanation&&e.jsx("p",{className:"mt-2 text-blue-700",children:s.explanation})]})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Credit Card Transactions:"}),s.ccTransactions.map((l,c)=>e.jsx("div",{className:"p-2 bg-white border border-blue-200 rounded text-xs",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-blue-50 text-blue-700",children:"CC"}),e.jsx("span",{className:"text-gray-900",children:l.description}),e.jsx("span",{className:"text-gray-500",children:l.date}),l.merchant&&e.jsxs("span",{className:"text-gray-400",children:["â€¢ ",l.merchant]})]}),e.jsxs("span",{className:`font-medium ${l.amount>=0?"text-red-600":"text-green-600"}`,children:["â‚¬",X(Math.abs(l.amount))]})]})},c))]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("div",{className:"text-xs font-medium text-gray-700",children:"Ledger Entries:"}),s.ledgerEntries.map((l,c)=>e.jsx("div",{className:"p-2 bg-white border border-blue-200 rounded text-xs",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(g,{variant:"outline",className:"text-xs bg-blue-50 text-blue-700",children:"Ledger"}),e.jsx("span",{className:"text-gray-900",children:l.description}),e.jsx("span",{className:"text-gray-500",children:l.date}),l.account&&e.jsxs("span",{className:"text-gray-400",children:["â€¢ ",l.account]})]}),e.jsxs("span",{className:`font-medium ${w(l)>=0?"text-green-600":"text-red-600"}`,children:["â‚¬",X(Math.abs(w(l)))]})]})},c))]}),e.jsx("div",{className:"flex gap-2 pt-3 mt-3 border-t border-blue-200",children:e.jsx(h,{type:"button",size:"sm",variant:"outline",className:"gap-2 bg-red-50 hover:bg-red-100 text-red-700 border-red-200",onClick:l=>{l.stopPropagation(),q(s)},disabled:U[`unmatch-${s.matchGroupId}`],children:U[`unmatch-${s.matchGroupId}`]?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-3 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(as,{className:"size-3"}),"Unmatch"]})})})]})]},a)})}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(he,{className:"size-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-gray-600",children:"No pre-matched transactions found."})]})})]})})]}),e.jsx(ns,{open:Ae,onOpenChange:me,children:e.jsxs(is,{children:[e.jsxs(ls,{children:[e.jsx(cs,{children:"Edit Transaction"}),e.jsx(os,{children:"Make corrections to the transaction details below."})]}),ae&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Re,{htmlFor:"edit-date",children:"Date"}),e.jsx(rs,{id:"edit-date",type:"date",value:ae.date||"",disabled:!0,className:"bg-gray-50 cursor-not-allowed"})]}),e.jsxs("div",{children:[e.jsx(Re,{htmlFor:"edit-description",children:"Description"}),e.jsx(rs,{id:"edit-description",value:ae.description||"",onChange:s=>fe({...ae,description:s.target.value})})]}),e.jsxs("div",{children:[e.jsx(Re,{htmlFor:"edit-amount",children:"Amount"}),e.jsx(rs,{id:"edit-amount",type:"number",step:"0.01",value:ae.amount||"",disabled:!0,className:"bg-gray-50 cursor-not-allowed"})]})]}),e.jsxs(ds,{children:[e.jsx(h,{variant:"outline",onClick:()=>me(!1),children:"Cancel"}),e.jsx(h,{onClick:Ue,children:"Save Changes"})]})]})}),e.jsx(ns,{open:Fe,onOpenChange:je,children:e.jsxs(is,{className:"max-w-[600px]",children:[e.jsxs(ls,{children:[e.jsxs(cs,{className:"flex items-center gap-2 text-xl",children:[e.jsx(Ne,{className:"size-5 text-purple-600"}),"Request Information"]}),e.jsx(os,{className:"text-gray-600",children:"Add a note about what information is needed for this transaction."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(Re,{className:"text-sm font-medium text-gray-700 mb-2",children:"What information do you need?"}),e.jsx(Es,{value:M,onChange:s=>te(s.target.value),placeholder:"e.g., Need vendor invoice from supplier, Waiting for client approval, Need clarification on purpose...",rows:5,className:"mt-2 resize-none"})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-start gap-2 mb-3",children:[e.jsx(vs,{className:"size-4 text-purple-600 mt-0.5"}),e.jsx("span",{className:"text-sm font-medium text-purple-900",children:"Common follow-ups:"})]}),e.jsxs("ul",{className:"space-y-2 ml-6",children:[e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Vendor invoice required"]}),e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Client inquiry needed"]}),e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Credit card statement clarification"]}),e.jsxs("li",{className:"flex items-center gap-2 text-sm text-purple-800",children:[e.jsx("div",{className:"size-1.5 rounded-full bg-purple-400"}),"Team member approval required"]})]})]})]}),e.jsxs(ds,{className:"gap-2",children:[e.jsx(h,{type:"button",variant:"outline",onClick:()=>je(!1),children:"Cancel"}),e.jsx(h,{type:"button",onClick:Ye,className:"bg-purple-600 hover:bg-purple-700",children:"Flag for Follow-Up"})]})]})}),e.jsx(ns,{open:xe,onOpenChange:f,children:e.jsxs(is,{className:"max-w-[90vw] w-[1600px] max-h-[90vh] overflow-hidden flex flex-col",children:[e.jsxs(ls,{children:[e.jsx(cs,{children:"Match Transactions - Multi-Select"}),e.jsx(os,{children:"Select one or more CC transactions and one or more ledger entries to match them together. Supports many-to-many matching."})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"sticky top-0 bg-white pb-3 border-b border-gray-200 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(Ms,{className:"size-4 text-red-600"}),"CC Transactions"]}),e.jsxs(g,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:[ee.length," selected"]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded p-3",children:[e.jsx("div",{className:"text-sm font-medium text-blue-900",children:"Selected Total:"}),e.jsxs("div",{className:`text-2xl font-medium ${ve()<0?"text-red-600":"text-green-600"}`,children:["â‚¬",X(Math.abs(ve()))]})]})]}),e.jsx("div",{className:"space-y-2",children:j&&j.map((s,a)=>{const i=ee.some(n=>n.transaction.id===s.transaction.id);return e.jsx("div",{className:`p-3 rounded-lg border-2 transition-all cursor-pointer ${i?"bg-blue-100 border-blue-500 shadow-md":"bg-red-50 border-red-200 hover:border-red-400"}`,onClick:()=>le(s),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(bs,{checked:i,onCheckedChange:()=>le(s),className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:s.transaction.description}),e.jsxs("div",{className:`text-lg font-medium ${s.transaction.amount<0?"text-red-600":"text-green-600"}`,children:["â‚¬",X(Math.abs(s.transaction.amount))]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:s.transaction.date}),s.transaction.merchant&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Merchant: ",s.transaction.merchant]})]})]})},a)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"sticky top-0 bg-white pb-3 border-b border-gray-200 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("h3",{className:"font-medium text-gray-900 flex items-center gap-2",children:[e.jsx(ps,{className:"size-4 text-amber-600"}),"Ledger Entries"]}),e.jsxs(g,{variant:"outline",className:"bg-amber-50 text-amber-700 border-amber-200",children:[oe.length," selected"]})]}),e.jsxs("div",{className:"bg-purple-50 border border-purple-200 rounded p-3",children:[e.jsx("div",{className:"text-sm font-medium text-purple-900",children:"Selected Total:"}),e.jsxs("div",{className:`text-2xl font-medium ${ge()<0?"text-green-600":"text-red-600"}`,children:["â‚¬",X(Math.abs(ge()))]})]})]}),e.jsx("div",{className:"space-y-2",children:I&&I.map((s,a)=>{const i=oe.some(n=>n.entry.id===s.entry.id);return e.jsx("div",{className:`p-3 rounded-lg border-2 transition-all cursor-pointer ${i?"bg-purple-100 border-purple-500 shadow-md":"bg-amber-50 border-amber-200 hover:border-amber-400"}`,onClick:()=>Ve(s),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(bs,{checked:i,onCheckedChange:()=>Ve(s),className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900",children:Ke(s.entry)}),e.jsxs("div",{className:`text-lg font-medium ${w(s.entry)<0?"text-green-600":"text-red-600"}`,children:["â‚¬",X(Math.abs(w(s.entry)))]})]}),e.jsx("div",{className:"text-xs text-gray-600",children:s.entry.date}),(s.entry.glAccount||s.entry.account)&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Account: ",s.entry.glAccount||s.entry.account]})]})]})},a)})})]})]})}),(ee.length>0||oe.length>0)&&e.jsx("div",{className:"border-t border-gray-200 pt-4",children:e.jsx("div",{className:`p-4 rounded-lg border-2 ${Math.abs(ve()-ge())<.01?"bg-green-50 border-green-500":"bg-yellow-50 border-yellow-500"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900 mb-1",children:Math.abs(ve()-ge())<.01?e.jsxs("span",{className:"text-green-700 flex items-center gap-2",children:[e.jsx(E,{className:"size-5"}),"Amounts Match - Ready to Reconcile"]}):e.jsxs("span",{className:"text-yellow-700 flex items-center gap-2",children:[e.jsx(we,{className:"size-5"}),"Amount Difference"]})}),e.jsxs("div",{className:"text-sm text-gray-600",children:["CC: â‚¬",X(Math.abs(ve()))," | Ledger: â‚¬",X(Math.abs(ge()))," | Diff: â‚¬",X(Math.abs(ve()-ge()))]})]}),e.jsxs(h,{type:"button",className:"gap-2 bg-green-600 hover:bg-green-700",onClick:()=>We(),disabled:H||ee.length===0||oe.length===0,children:[e.jsx(he,{className:"size-4"}),"Match ",ee.length," CC â†” ",oe.length," Ledger"]})]})})}),e.jsx(ds,{children:e.jsx(h,{type:"button",variant:"outline",onClick:()=>{f(!1),b([]),v([])},children:"Cancel"})})]})})]})}function st({companyId:T,companyName:Se,period:k,onBack:De}){const[x,W]=m.useState(null),[R,ke]=m.useState(!1),[ue,ne]=m.useState(!1),Ae=m.useRef(null);m.useEffect(()=>{me()},[]);const me=async()=>{ne(!0);try{const u=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/trial-balance/get?companyId=${T}&period=${k}`,{headers:{Authorization:`Bearer ${$}`}});if(u.ok){const _=await u.json();W(_)}else u.status===404?W(null):console.error("Failed to load trial balance:",await u.text())}catch(u){console.error("Error loading trial balance:",u)}finally{ne(!1)}},Fe=()=>{Ae.current?.click()},je=async u=>{const _=u.target.files?.[0];if(!_)return;if(!["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv"].includes(_.type)&&!_.name.endsWith(".csv")&&!_.name.endsWith(".xlsx")&&!_.name.endsWith(".xls")){o.error("Invalid file type. Please upload an Excel (.xlsx, .xls) or CSV file.");return}ke(!0);try{const[ie,p]=k.split("-").map(Number),se=new Date(ie,p-2,1),M=`${se.getFullYear()}-${String(se.getMonth()+1).padStart(2,"0")}`,te=new FormData;te.append("file",_),te.append("companyId",T),te.append("period",k),te.append("previousPeriod",M);const U=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/trial-balance/upload`,{method:"POST",headers:{Authorization:`Bearer ${$}`},body:te});if(U.ok){const P=await U.json();W(P),P.structuralErrors.length>0?o.error("Trial Balance has structural errors and cannot be closed."):P.analyticalWarnings.length>0?o.warning(`Trial Balance uploaded with ${P.analyticalWarnings.length} warnings.`):o.success("Trial Balance uploaded and validated successfully!")}else{const P=await U.json();o.error(P.error||"Failed to upload trial balance"),console.error("Upload error:",P)}}catch(ie){console.error("Error uploading trial balance:",ie),o.error("Failed to upload trial balance. Please try again.")}finally{ke(!1),Ae.current&&(Ae.current.value="")}},ae=async()=>{try{const u=await Fs(()=>import("./xlsx-DGuHH-KN.js"),[]),_=u.utils.book_new(),_e=[["Account Name","Account Code","Debit","Credit"],["Cash and Cash Equivalents","1000",5e4,0],["Accounts Receivable","1100",25e3,0],["Inventory","1200",15e3,0],["Accounts Payable","2000",0,18e3],["Credit Card Payable","2100",0,3500],["Revenue","4000",0,12e4],["Cost of Goods Sold","5000",48e3,0],["Salaries Expense","6000",3e4,0],["Rent Expense","6100",5e3,0],["Utilities Expense","6200",2500,0],["","","",""],["TOTALS","","=SUM(C2:C11)","=SUM(D2:D11)"]],ie=u.utils.aoa_to_sheet(_e);ie["!cols"]=[{wch:30},{wch:15},{wch:15},{wch:15}],u.utils.book_append_sheet(_,ie,"Trial Balance Template"),u.writeFile(_,"TrialBalance_Template.xlsx"),o.success("Template downloaded successfully!")}catch(u){console.error("Error downloading template:",u),o.error("Failed to download template")}},fe=async()=>{if(x)try{const u=await Fs(()=>import("./xlsx-DGuHH-KN.js"),[]),_=u.utils.book_new(),_e=[["TRIAL BALANCE SUMMARY"],[""],["Company",Se],["Period",k],["Upload Date",new Date(x.uploadedAt).toLocaleString()],[""],["Total Debits",x.summary.totalDebits.toFixed(2)],["Total Credits",x.summary.totalCredits.toFixed(2)],["Difference",x.summary.difference.toFixed(2)],["Status",x.isBalanced?"BALANCED":"UNBALANCED"],[""],["Total Accounts",x.summary.totalAccounts],["Total Revenue",x.summary.totalRevenue.toFixed(2)],["Total Expenses",x.summary.totalExpenses.toFixed(2)]],ie=u.utils.aoa_to_sheet(_e);u.utils.book_append_sheet(_,ie,"Summary");const p=[["Account Name","Account Code","Debit","Credit","Balance"]];x.entries.forEach(M=>{p.push([M.account_name||"",M.account_code||"",M.debit.toFixed(2),M.credit.toFixed(2),(M.debit-M.credit).toFixed(2)])});const se=u.utils.aoa_to_sheet(p);if(u.utils.book_append_sheet(_,se,"Entries"),x.structuralErrors.length>0){const M=[["Type","Title","Message","Recommendation"]];x.structuralErrors.forEach(U=>{M.push([U.type,U.title,U.message,U.recommendation])});const te=u.utils.aoa_to_sheet(M);u.utils.book_append_sheet(_,te,"Errors")}if(x.analyticalWarnings.length>0){const M=[["Type","Title","Message","Account","Recommendation"]];x.analyticalWarnings.forEach(U=>{M.push([U.type,U.title,U.message,U.details?.account||"",U.recommendation])});const te=u.utils.aoa_to_sheet(M);u.utils.book_append_sheet(_,te,"Warnings")}u.writeFile(_,`TrialBalance_${Se}_${k}.xlsx`),o.success("Trial Balance exported successfully!")}catch(u){console.error("Error exporting trial balance:",u),o.error("Failed to export trial balance")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(h,{variant:"ghost",size:"sm",onClick:De,children:[e.jsx(xs,{className:"size-4 mr-2"}),"Back to Month-End Close"]}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl text-gray-900",children:"Trial Balance Review"}),e.jsxs("p",{className:"text-gray-500 mt-1",children:[Se," â€¢ ",k]})]})]}),x&&e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:fe,children:[e.jsx(Ds,{className:"size-4 mr-2"}),"Export Report"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:Fe,children:[e.jsx(Cs,{className:"size-4 mr-2"}),"Re-upload"]})]})]}),e.jsx("input",{ref:Ae,type:"file",accept:".xlsx,.xls,.csv",onChange:je,className:"hidden"}),ue?e.jsx(D,{children:e.jsx(F,{className:"py-12",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ce,{className:"size-12 text-purple-600 mx-auto mb-4 animate-spin"}),e.jsx("p",{className:"text-gray-600",children:"Loading trial balance..."})]})})}):x?e.jsxs("div",{className:"space-y-6",children:[e.jsx(D,{children:e.jsx(F,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[x.isBalanced?e.jsx(E,{className:"size-12 text-green-600"}):e.jsx(As,{className:"size-12 text-red-600"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl text-gray-900",children:x.isBalanced?"Trial Balance is Balanced":"Trial Balance is Unbalanced"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:x.canClose?"No structural errors found. You may proceed with month-end close.":"Structural errors prevent month-end close. Please resolve errors before proceeding."})]})]}),e.jsx(g,{variant:"outline",className:x.canClose?"bg-green-50 text-green-700 border-green-200":"bg-red-50 text-red-700 border-red-200",children:x.canClose?"Can Close":"Cannot Close"})]})})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(D,{children:e.jsxs(F,{className:"pt-6",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Total Debits"}),e.jsxs("div",{className:"text-2xl text-gray-900 mt-1",children:["â‚¬",x.summary.totalDebits.toLocaleString("en-US",{minimumFractionDigits:2})]})]})}),e.jsx(D,{children:e.jsxs(F,{className:"pt-6",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Total Credits"}),e.jsxs("div",{className:"text-2xl text-gray-900 mt-1",children:["â‚¬",x.summary.totalCredits.toLocaleString("en-US",{minimumFractionDigits:2})]})]})}),e.jsx(D,{children:e.jsxs(F,{className:"pt-6",children:[e.jsx("div",{className:"text-sm text-gray-600",children:"Difference"}),e.jsxs("div",{className:`text-2xl mt-1 ${x.summary.difference<.01?"text-green-600":"text-red-600"}`,children:["â‚¬",x.summary.difference.toLocaleString("en-US",{minimumFractionDigits:2})]})]})})]}),x.structuralErrors.length>0&&e.jsxs(D,{className:"border-red-200",children:[e.jsxs(B,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(As,{className:"size-5 text-red-600"}),e.jsxs(L,{className:"text-red-900",children:["Structural Errors (",x.structuralErrors.length,")"]})]}),e.jsx(pe,{className:"text-red-700",children:"These errors prevent month-end close and must be resolved."})]}),e.jsx(F,{className:"space-y-3",children:x.structuralErrors.map((u,_)=>e.jsx("div",{className:"p-4 bg-red-50 border border-red-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(we,{className:"size-5 text-red-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-sm text-red-900",children:u.title}),e.jsx(g,{variant:"outline",className:"bg-red-100 text-red-700 border-red-300",children:u.type})]}),e.jsx("p",{className:"text-sm text-red-800 mb-2",children:u.message}),u.details&&e.jsxs("div",{className:"text-xs text-red-700 mb-2 p-2 bg-red-100 rounded",children:[e.jsxs("div",{children:["Total Debits: â‚¬",u.details.totalDebits?.toFixed(2)]}),e.jsxs("div",{children:["Total Credits: â‚¬",u.details.totalCredits?.toFixed(2)]}),e.jsxs("div",{className:"",children:["Difference: â‚¬",u.details.difference?.toFixed(2)]})]}),e.jsxs("p",{className:"text-xs text-red-700",children:[e.jsx("strong",{children:"Action:"})," ",u.recommendation]})]})]})},_))})]}),x.analyticalWarnings.length>0&&e.jsxs(D,{className:"border-yellow-200",children:[e.jsxs(B,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ws,{className:"size-5 text-yellow-600"}),e.jsxs(L,{className:"text-yellow-900",children:["Analytical Warnings (",x.analyticalWarnings.length,")"]})]}),e.jsx(pe,{className:"text-yellow-700",children:"These warnings indicate unusual balances or variances but do not block month-end close."})]}),e.jsx(F,{className:"space-y-3",children:x.analyticalWarnings.map((u,_)=>e.jsx("div",{className:"p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ws,{className:"size-5 text-yellow-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("h4",{className:"text-sm text-yellow-900",children:u.title}),e.jsx(g,{variant:"outline",className:"bg-yellow-100 text-yellow-700 border-yellow-300",children:u.type})]}),e.jsx("p",{className:"text-sm text-yellow-800 mb-2",children:u.message}),u.details&&u.details.account&&e.jsxs("div",{className:"text-xs text-yellow-700 mb-2 p-2 bg-yellow-100 rounded",children:[e.jsxs("div",{children:["Account: ",u.details.account]}),u.details.currentBalance!==void 0&&e.jsxs("div",{children:["Current Balance: â‚¬",Math.abs(u.details.currentBalance).toFixed(2)]}),u.details.percentChange!==void 0&&e.jsxs("div",{children:["Change vs Prior Month: ",u.details.percentChange.toFixed(1),"%"]})]}),e.jsxs("p",{className:"text-xs text-yellow-700",children:[e.jsx("strong",{children:"Suggestion:"})," ",u.recommendation]})]})]})},_))})]}),x.structuralErrors.length===0&&x.analyticalWarnings.length===0&&e.jsx(D,{className:"border-green-200",children:e.jsx(F,{className:"py-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx(E,{className:"size-12 text-green-600 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg text-green-900 mb-2",children:"Trial Balance Looks Great!"}),e.jsx("p",{className:"text-sm text-green-700",children:"No errors or warnings detected. Your books are balanced and ready for month-end close."})]})})})]}):e.jsxs(D,{children:[e.jsxs(B,{children:[e.jsx(L,{children:"Upload Trial Balance"}),e.jsxs(pe,{children:["Upload an Excel or CSV file containing your trial balance for ",k]})]}),e.jsx(F,{children:e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-purple-400 transition-colors",children:R?e.jsxs("div",{children:[e.jsx(ce,{className:"size-12 text-purple-600 mx-auto mb-4 animate-spin"}),e.jsx("p",{className:"text-gray-600",children:"Uploading and analyzing trial balance..."})]}):e.jsxs("div",{children:[e.jsx(ks,{className:"size-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Click to upload your trial balance or drag and drop"}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsxs(h,{onClick:Fe,children:[e.jsx(Cs,{className:"size-4 mr-2"}),"Choose File"]}),e.jsxs(h,{variant:"outline",onClick:ae,children:[e.jsx(Ds,{className:"size-4 mr-2"}),"Download Template"]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-4",children:"Supported formats: Excel (.xlsx, .xls) or CSV"}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Required columns: Account Name, Debit, Credit (or Balance)"})]})})})]})]})}function yt({companyId:T,companyName:Se}){const[k,De]=m.useState([]),[x,W]=m.useState(null),[R,ke]=m.useState(""),[ue,ne]=m.useState(null),[Ae,me]=m.useState(!1),[Fe,je]=m.useState(!1),[ae,fe]=m.useState(!1),[u,_]=m.useState(!1),[_e,ie]=m.useState(!1),[p,se]=m.useState(null),[M,te]=m.useState(!1),[U,P]=m.useState(null),[Ie,Le]=m.useState(!1),[j,O]=m.useState(null),[I,G]=m.useState(!1),[K,S]=m.useState(!1),Te=m.useRef(null),[qe,xe]=m.useState(!1),[f,ee]=m.useState(null),[b,oe]=m.useState(!1),[v,H]=m.useState(!1);m.useEffect(()=>{hs();const d=new Date,N=d.getFullYear(),q=(d.getMonth()+1).toString().padStart(2,"0");ke(`${N}-${q}`)},[]);const Z=(()=>{const d=[],N=new Date;for(let q=0;q<12;q++){const J=new Date(N.getFullYear(),N.getMonth()-q,1),le=J.getFullYear(),Ve=(J.getMonth()+1).toString().padStart(2,"0"),ve=`${le}-${Ve}`,ge=J.toLocaleDateString("en-US",{month:"long",year:"numeric"});d.push({value:ve,label:ge})}return d})();m.useEffect(()=>{x&&R&&(w(),Oe(),Ce(),X(),ye())},[x,R]);const hs=async()=>{try{const d=await qs.getAll();if(De(d||[]),T){const N=d.find(q=>q.id===T);N&&W(N)}else d.length>0&&W(d[0])}catch(d){console.error("Failed to load companies:",d)}},Oe=async()=>{if(!(!x||!R)){me(!0);try{const d=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/bank-rec/reconciliation?companyId=${x.id}&period=${R}`,{headers:{Authorization:`Bearer ${$}`}});if(d.ok){const N=await d.json();console.log("Month-End Close - Reconciliation data loaded:",N),ne(N)}else if(d.status===404)console.log("Month-End Close - No bank reconciliation found for this period (not yet run)"),ne(null);else{const N=await d.text();console.error("Month-End Close - Failed to load reconciliation:",d.status,N),ne(null)}}catch(d){console.error("Month-End Close - Failed to load reconciliation data:",d),ne(null)}finally{me(!1)}}},Ce=async()=>{if(!(!x||!R)){te(!0);try{const d=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/ap-rec/reconciliation?companyId=${x.id}&period=${R}`,{headers:{Authorization:`Bearer ${$}`}});if(d.ok){const N=await d.json();console.log("Month-End Close - AP Reconciliation data loaded:",N),se(N)}else if(d.status===404)console.log("Month-End Close - No AP reconciliation found for this period (not yet run)"),se(null);else{const N=await d.text();console.error("Month-End Close - Failed to load AP reconciliation:",d.status,N),se(null)}}catch(d){console.error("Month-End Close - Failed to load AP reconciliation data:",d),se(null)}finally{te(!1)}}},X=async()=>{if(!(!x||!R)){Le(!0);try{const d=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/cc-rec/reconciliation?companyId=${x.id}&period=${R}`,{headers:{Authorization:`Bearer ${$}`}});if(d.ok){const N=await d.json();console.log("Month-End Close - CC Reconciliation data loaded:",N),P(N.reconciliation||N)}else if(d.status===404)console.log("Month-End Close - No CC reconciliation found for this period (not yet run)"),P(null);else{const N=await d.text();console.error("Month-End Close - Failed to load CC reconciliation:",d.status,N),P(null)}}catch(d){console.error("Month-End Close - Failed to load CC reconciliation data:",d),P(null)}finally{Le(!1)}}},ye=async()=>{if(!(!x||!R)){G(!0);try{const d=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/trial-balance/get?companyId=${x.id}&period=${R}`,{headers:{Authorization:`Bearer ${$}`}});if(d.ok){const N=await d.json();console.log("Month-End Close - Trial Balance data loaded:",N),O(N)}else if(d.status===404)console.log("Month-End Close - No trial balance found for this period (not yet uploaded)"),O(null);else{const N=await d.text();console.error("Month-End Close - Failed to load trial balance:",d.status,N),O(null)}}catch(d){console.error("Month-End Close - Failed to load trial balance data:",d),O(null)}finally{G(!1)}}},w=async()=>{if(!(!x||!R))try{const d=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/month-close/status?companyId=${x.id}&period=${R}`,{headers:{Authorization:`Bearer ${$}`}});if(d.ok){const N=await d.json();xe(N.isLocked||!1),ee(N.isLocked?N:null),console.log("Month lock status:",N)}}catch(d){console.error("Failed to load lock status:",d)}},Ke=async()=>{oe(!0);try{const d=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/month-close/close`,{method:"POST",headers:{Authorization:`Bearer ${$}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:x.id,period:R,closedBy:"current-user"})}),N=await d.text();if(d.ok)try{const q=JSON.parse(N);console.log("Month close response:",q),o.success("Month closed and locked successfully!"),H(!1),await w()}catch(q){console.error("Error parsing success response:",q,N),o.error("Unexpected response format from server")}else{let q="Failed to close month";try{q=JSON.parse(N).error||q}catch{console.error("Non-JSON error response:",N),q=N||q}o.error(q)}}catch(d){console.error("Error closing month:",d),o.error(`Failed to close month: ${d instanceof Error?d.message:"Unknown error"}`)}finally{oe(!1)}},ms=()=>ue?(ue.unmatched_bank?.length||0)>0||(ue.unmatched_ledger?.length||0)>0?e.jsx(g,{className:"bg-yellow-100 text-yellow-700 border-yellow-200",children:"In Progress"}):e.jsx(g,{className:"bg-blue-100 text-blue-700 border-blue-200",children:"Ready to Close"}):e.jsx(g,{className:"bg-gray-100 text-gray-700 border-gray-200",children:"Not Started"}),Ue=ue&&(ue.unmatched_bank?.length||0)===0&&(ue.unmatched_ledger?.length||0)===0,Je=p&&(p.unmatchedVendor?.length||0)===0&&(p.unmatchedAP?.length||0)===0,Ge=U&&(U.unmatched_cc?.length||0)===0&&(U.unmatched_ledger?.length||0)===0,Ee=j&&j.isBalanced&&j.canClose,Ye=()=>{Te.current?.click()},Xe=async d=>{const N=d.target.files?.[0];if(!N||!x||!R)return;if(!["application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/csv"].includes(N.type)&&!N.name.endsWith(".csv")&&!N.name.endsWith(".xlsx")&&!N.name.endsWith(".xls")){o.error("Invalid file type. Please upload an Excel (.xlsx, .xls) or CSV file.");return}S(!0),o.info("Uploading trial balance file...",{duration:2e3});try{const[J,le]=R.split("-").map(Number),Ve=new Date(J,le-2,1),ve=`${Ve.getFullYear()}-${String(Ve.getMonth()+1).padStart(2,"0")}`,ge=new FormData;ge.append("file",N),ge.append("companyId",x.id),ge.append("period",R),ge.append("previousPeriod",ve);const He=await fetch(`https://${z}.supabase.co/functions/v1/make-server-53c2e113/trial-balance/upload`,{method:"POST",headers:{Authorization:`Bearer ${$}`},body:ge});if(He.ok){const be=await He.json();O(be),be.structuralErrors.length>0?o.error(`Trial Balance uploaded but has ${be.structuralErrors.length} critical error(s).`):be.analyticalWarnings.length>0?o.warning(`Trial Balance uploaded with ${be.analyticalWarnings.length} warning(s).`):o.success("âœ“ Trial Balance uploaded and validated successfully!")}else{const be=await He.text();let We="Failed to upload trial balance";try{We=JSON.parse(be).error||We}catch{We=be||We}o.error(We),console.error("Upload error:",be)}}catch(J){console.error("Error uploading trial balance:",J),o.error("Failed to upload trial balance. Please try again.")}finally{S(!1),Te.current&&(Te.current.value="")}},ts=async()=>{try{const d=await Fs(()=>import("./xlsx-DGuHH-KN.js"),[]),N=d.utils.book_new(),q=[["Account Name","Account Code","Debit","Credit"],["Cash and Cash Equivalents","1000",5e4,0],["Accounts Receivable","1100",25e3,0],["Inventory","1200",15e3,0],["Accounts Payable","2000",0,18e3],["Credit Card Payable","2100",0,3500],["Revenue","4000",0,12e4],["Cost of Goods Sold","5000",48e3,0],["Salaries Expense","6000",3e4,0],["Rent Expense","6100",5e3,0],["Utilities Expense","6200",2500,0],["","","",""],["TOTALS","","=SUM(C2:C11)","=SUM(D2:D11)"]],J=d.utils.aoa_to_sheet(q);J["!cols"]=[{wch:30},{wch:15},{wch:15},{wch:15}],d.utils.book_append_sheet(N,J,"Trial Balance Template"),d.writeFile(N,"TrialBalance_Template.xlsx"),o.success("Template downloaded successfully!")}catch(d){console.error("Error downloading template:",d),o.error("Failed to download template")}};return _e&&x?e.jsx(st,{companyId:x.id,companyName:x.name,period:R,onBack:()=>{ie(!1),ye()}}):Fe&&x?e.jsx(Zs,{companyId:x.id,companyName:x.name,period:R,onBack:()=>{je(!1),Oe()}}):ae&&x?e.jsx(Qs,{companyId:x.id,companyName:x.name,period:R,onBack:()=>{fe(!1),Oe(),Ce()}}):u&&x?e.jsx(et,{companyId:x.id,companyName:x.name,period:R,onBack:()=>{_(!1),X()}}):e.jsxs("div",{className:"space-y-6",children:[qe&&e.jsx("div",{className:"bg-gray-900 text-white p-3 rounded-lg border border-gray-800",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(js,{className:"size-4"}),e.jsxs("p",{className:"text-sm",children:["Period locked Â· Closed ",f?.closedAt?new Date(f.closedAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):""]})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl text-gray-900",children:"Month-End Close"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"AI-powered close preparation & adjusting entries"})]}),e.jsxs(Qe,{children:[e.jsx(es,{asChild:!0,children:e.jsxs(h,{variant:"outline",className:"gap-2",children:[e.jsx(Vs,{className:"size-4"}),x?.name||"Select Company",e.jsx(gs,{className:"size-4"})]})}),e.jsx(ss,{align:"start",className:"w-[300px]",children:k.map(d=>e.jsx(Q,{onClick:()=>W(d),className:x?.id===d.id?"bg-purple-50":"",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm",children:d.name}),e.jsx("span",{className:"text-xs text-gray-500",children:d.industry})]})},d.id))})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(Qe,{children:[e.jsx(es,{asChild:!0,children:e.jsxs(h,{variant:"outline",className:"gap-2",children:[e.jsx(Ws,{className:"size-4"}),Z.find(d=>d.value===R)?.label,e.jsx(gs,{className:"size-4"})]})}),e.jsx(ss,{align:"end",children:Z.map(d=>e.jsx(Q,{onClick:()=>ke(d.value),className:R===d.value?"bg-purple-50":"",children:d.label},d.value))})]}),ms()]})]}),e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"size-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-sm",children:"1"}),e.jsx(L,{children:"Pre-Close Checklist"})]})}),e.jsxs(F,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[Ue?e.jsx(E,{className:"size-5 text-green-600"}):Ae?e.jsx(ce,{className:"size-5 text-gray-400 animate-spin"}):ue?e.jsx(we,{className:"size-5 text-yellow-600"}):e.jsx(us,{className:"size-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-900",children:"Review Bank Reconciliation"}),e.jsx("p",{className:"text-xs text-gray-500",children:Ae?"Loading reconciliation data...":ue?e.jsxs(e.Fragment,{children:[ue.unmatched_bank?.length||0," unmatched bank, ",ue.unmatched_ledger?.length||0," unmatched ledger"]}):"No reconciliation found for this period"})]})]}),e.jsxs(h,{size:"sm",variant:"ghost",className:"gap-1",onClick:()=>je(!0),children:[Ue?"Review":"Start",e.jsx($s,{className:"size-4"})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[Je?e.jsx(E,{className:"size-5 text-green-600"}):M?e.jsx(ce,{className:"size-5 text-gray-400 animate-spin"}):p?e.jsx(we,{className:"size-5 text-yellow-600"}):e.jsx(us,{className:"size-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-900",children:"Review AP Reconciliation"}),e.jsx("p",{className:"text-xs text-gray-500",children:M?"Loading AP reconciliation data...":p?e.jsxs(e.Fragment,{children:[p.unmatchedVendor?.length||0," unmatched vendor, ",p.unmatchedAP?.length||0," unmatched AP"]}):"No AP reconciliation found for this period"})]})]}),e.jsxs(h,{size:"sm",variant:"ghost",className:"gap-1",onClick:()=>fe(!0),children:[Je?"Review":"Start",e.jsx($s,{className:"size-4"})]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[Ge?e.jsx(E,{className:"size-5 text-green-600"}):Ie?e.jsx(ce,{className:"size-5 text-gray-400 animate-spin"}):U?e.jsx(we,{className:"size-5 text-yellow-600"}):e.jsx(us,{className:"size-5 text-gray-400"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-900",children:"Review CC Reconciliation"}),e.jsx("p",{className:"text-xs text-gray-500",children:Ie?"Loading CC reconciliation data...":U?e.jsxs(e.Fragment,{children:[U.unmatched_cc?.length||0," unmatched CC, ",U.unmatched_ledger?.length||0," unmatched ledger"]}):"No CC reconciliation found for this period"})]})]}),e.jsxs(h,{size:"sm",variant:"ghost",className:"gap-1",onClick:()=>_(!0),children:[Ge?"Review":"Start",e.jsx($s,{className:"size-4"})]})]})]})]}),e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"size-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-sm",children:"2"}),e.jsx(L,{children:"Trial Balance Review"})]})}),e.jsxs(F,{className:"space-y-6",children:[e.jsx("input",{ref:Te,type:"file",accept:".xlsx,.xls,.csv",onChange:Xe,className:"hidden"}),I?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ce,{className:"size-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("p",{className:"text-gray-600",children:"Analyzing trial balance with AI..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Detecting columns and validating balances"})]}):j?e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-start justify-between p-4 border rounded-lg bg-gray-50",children:e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[Ee?e.jsx(E,{className:"size-6 text-green-600 mt-0.5"}):j&&!j.canClose?e.jsx(As,{className:"size-6 text-red-600 mt-0.5"}):e.jsx(ws,{className:"size-6 text-yellow-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm",children:j.isBalanced?e.jsx("span",{className:"text-green-700",children:"âœ“ Trial Balance is Balanced"}):e.jsx("span",{className:"text-red-700",children:"âœ— Trial Balance is Unbalanced"})}),e.jsxs(h,{variant:"outline",size:"sm",onClick:Ye,children:[e.jsx(Cs,{className:"size-4 mr-2"}),"Re-upload"]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Total Accounts"}),e.jsx("p",{className:"text-sm text-gray-900",children:j.summary?.totalAccounts||0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Structural Errors"}),e.jsx("p",{className:"text-sm text-gray-900",children:j.structuralErrors?.length||0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Warnings"}),e.jsx("p",{className:"text-sm text-gray-900",children:j.analyticalWarnings?.length||0})]})]})]})]})}),j.summary&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx("p",{className:"text-xs text-blue-600 mb-1",children:"Total Debits"}),e.jsxs("p",{className:"text-lg text-gray-900",children:["â‚¬",j.summary.totalDebits?.toLocaleString("de-DE",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"p-4 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx("p",{className:"text-xs text-blue-600 mb-1",children:"Total Credits"}),e.jsxs("p",{className:"text-lg text-gray-900",children:["â‚¬",j.summary.totalCredits?.toLocaleString("de-DE",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"p-4 bg-purple-50 rounded-lg border border-purple-100",children:[e.jsx("p",{className:"text-xs text-purple-600 mb-1",children:"Total Revenue"}),e.jsxs("p",{className:"text-lg text-gray-900",children:["â‚¬",j.summary.totalRevenue?.toLocaleString("de-DE",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"p-4 bg-orange-50 rounded-lg border border-orange-100",children:[e.jsx("p",{className:"text-xs text-orange-600 mb-1",children:"Total Expenses"}),e.jsxs("p",{className:"text-lg text-gray-900",children:["â‚¬",j.summary.totalExpenses?.toLocaleString("de-DE",{minimumFractionDigits:2})]})]})]}),j.summary&&j.summary.difference>.01&&e.jsx("div",{className:"border-l-4 border-red-500 bg-red-50 p-4 rounded",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ws,{className:"size-5 text-red-600 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-red-900",children:"Debits and Credits Don't Match"}),e.jsxs("p",{className:"text-xs text-red-700 mt-1",children:["Difference: â‚¬",j.summary.difference.toFixed(2),"(Debits â‚¬",j.summary.totalDebits.toFixed(2)," - Credits â‚¬",j.summary.totalCredits.toFixed(2),")"]}),e.jsx("p",{className:"text-xs text-red-600 mt-2",children:"âš ï¸ You cannot close the month until the trial balance is balanced."})]})]})}),j.structuralErrors?.length>0&&e.jsxs("div",{className:"border border-red-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-red-50 px-4 py-3 border-b border-red-200",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(As,{className:"size-5 text-red-600"}),e.jsxs("h4",{className:"text-sm text-red-900",children:[j.structuralErrors.length," Critical Error(s) - Must Fix Before Close"]})]})}),e.jsx("div",{className:"divide-y divide-red-100",children:j.structuralErrors.map((d,N)=>e.jsx("div",{className:"p-4 bg-white",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"size-8 rounded-full bg-red-100 text-red-700 flex items-center justify-center text-xs flex-shrink-0",children:N+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-red-900",children:d.title}),e.jsx("p",{className:"text-xs text-red-700 mt-1",children:d.message}),d.recommendation&&e.jsxs("div",{className:"mt-2 p-2 bg-red-50 rounded text-xs text-red-800",children:[e.jsx("span",{className:"font-medium",children:"ðŸ’¡ Recommendation:"})," ",d.recommendation]})]})]})},N))})]}),j.analyticalWarnings?.length>0&&e.jsxs("div",{className:"border border-yellow-200 rounded-lg overflow-hidden",children:[e.jsx("div",{className:"bg-yellow-50 px-4 py-3 border-b border-yellow-200",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ws,{className:"size-5 text-yellow-600"}),e.jsxs("h4",{className:"text-sm text-yellow-900",children:[j.analyticalWarnings.length," Warning(s) - Review Recommended"]})]})}),e.jsx("div",{className:"divide-y divide-yellow-100 max-h-96 overflow-y-auto",children:j.analyticalWarnings.map((d,N)=>e.jsx("div",{className:"p-4 bg-white",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"size-8 rounded-full bg-yellow-100 text-yellow-700 flex items-center justify-center text-xs flex-shrink-0",children:N+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm text-yellow-900",children:d.title}),e.jsx("p",{className:"text-xs text-yellow-700 mt-1",children:d.message}),d.recommendation&&e.jsxs("div",{className:"mt-2 p-2 bg-yellow-50 rounded text-xs text-yellow-800",children:[e.jsx("span",{className:"font-medium",children:"ðŸ’¡ Recommendation:"})," ",d.recommendation]}),d.details&&e.jsxs("details",{className:"mt-2",children:[e.jsx("summary",{className:"text-xs text-yellow-600 cursor-pointer hover:text-yellow-700",children:"View details"}),e.jsx("pre",{className:"mt-2 text-xs text-gray-600 bg-gray-50 p-2 rounded overflow-auto",children:JSON.stringify(d.details,null,2)})]})]})]})},N))})]}),j.isBalanced&&j.structuralErrors?.length===0&&j.analyticalWarnings?.length===0&&e.jsx("div",{className:"border-l-4 border-green-500 bg-green-50 p-4 rounded",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(E,{className:"size-5 text-green-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-green-900",children:"Trial Balance Verified âœ“"}),e.jsx("p",{className:"text-xs text-green-700 mt-1",children:"All accounts are balanced with no errors or warnings. You're ready to proceed with month-end close!"})]})]})})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-gray-900",children:"Upload Trial Balance"}),e.jsxs("p",{className:"text-sm text-gray-500 mt-1",children:["Upload an Excel or CSV file containing your trial balance for ",R]})]}),e.jsx("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-blue-400 transition-colors",children:K?e.jsxs("div",{children:[e.jsx(ce,{className:"size-12 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("p",{className:"text-gray-600",children:"Uploading and analyzing trial balance..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"AI is detecting columns and validating balances"})]}):e.jsxs("div",{children:[e.jsx(ks,{className:"size-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Click to upload your trial balance or drag and drop"}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(h,{onClick:Ye,disabled:K,children:K?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-4 mr-2 animate-spin"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Cs,{className:"size-4 mr-2"}),"Choose File"]})}),e.jsxs(h,{variant:"outline",onClick:ts,children:[e.jsx(Ds,{className:"size-4 mr-2"}),"Download Template"]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-4",children:"Supported formats: Excel (.xlsx, .xls) or CSV"}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"AI will automatically detect your column structure - any format works!"})]})})]})]})]}),e.jsxs(D,{children:[e.jsx(B,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"size-8 rounded-full bg-gray-900 text-white flex items-center justify-center text-sm",children:"3"}),e.jsx(L,{children:"Close & Lock Period"})]})}),e.jsx(F,{className:"space-y-4",children:qe?e.jsx("div",{className:"flex items-center justify-between p-4 bg-gray-50 border border-gray-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"size-10 rounded-full bg-gray-900 flex items-center justify-center",children:e.jsx(js,{className:"size-5 text-white"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-900",children:"Period Locked"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Closed ",f?.closedAt?new Date(f.closedAt).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}):""]})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsx("div",{className:`p-3 rounded-lg border transition-all ${Ue?"bg-green-50 border-green-200":"bg-gray-50 border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[Ue?e.jsx(E,{className:"size-4 text-green-600"}):e.jsx(us,{className:"size-4 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-700",children:"Bank Reconciliation"})]})}),e.jsx("div",{className:`p-3 rounded-lg border transition-all ${Je?"bg-green-50 border-green-200":"bg-gray-50 border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[Je?e.jsx(E,{className:"size-4 text-green-600"}):e.jsx(us,{className:"size-4 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-700",children:"AP Reconciliation"})]})}),e.jsx("div",{className:`p-3 rounded-lg border transition-all ${Ge?"bg-green-50 border-green-200":"bg-gray-50 border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[Ge?e.jsx(E,{className:"size-4 text-green-600"}):e.jsx(us,{className:"size-4 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-700",children:"CC Reconciliation"})]})}),e.jsx("div",{className:`p-3 rounded-lg border transition-all ${Ee?"bg-green-50 border-green-200":"bg-gray-50 border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[Ee?e.jsx(E,{className:"size-4 text-green-600"}):e.jsx(us,{className:"size-4 text-gray-400"}),e.jsx("span",{className:"text-xs text-gray-700",children:"Trial Balance"})]})})]}),Ue&&Je&&Ge&&Ee?e.jsxs(h,{size:"lg",onClick:()=>H(!0),className:"w-full bg-gray-900 hover:bg-gray-800 text-white",children:[e.jsx(js,{className:"size-4 mr-2"}),"Close ",Z.find(d=>d.value===R)?.label]}):e.jsx(h,{size:"lg",disabled:!0,className:"w-full",children:"Complete All Requirements to Close"}),e.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Once closed, this period will be locked and read-only"})]})})]}),v&&e.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",onClick:()=>!b&&H(!1),children:e.jsxs("div",{className:"bg-white rounded-xl max-w-md w-full p-6 space-y-6",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl text-gray-900",children:"Close Period?"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-2",children:["You're about to close ",Z.find(d=>d.value===R)?.label," for ",x?.name,"."]})]}),e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg space-y-2",children:[e.jsx("p",{className:"text-xs text-gray-700",children:"This will:"}),e.jsxs("ul",{className:"text-xs text-gray-600 space-y-1 ml-4",children:[e.jsx("li",{children:"â€¢ Lock all reconciliations (read-only)"}),e.jsx("li",{children:"â€¢ Lock trial balance data"}),e.jsx("li",{children:"â€¢ Prevent new transactions for this period"})]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(h,{variant:"outline",onClick:()=>H(!1),disabled:b,className:"flex-1",children:"Cancel"}),e.jsx(h,{onClick:Ke,disabled:b,className:"flex-1 bg-gray-900 hover:bg-gray-800 text-white",children:b?e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"size-4 mr-2 animate-spin"}),"Closing..."]}):e.jsx(e.Fragment,{children:"Close Period"})})]})]})})]})}export{yt as MonthEndClose};
